<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market Stats | Dashboard</title>
    <link rel="icon" type="image/x-icon" href="public\images\chart.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'background': '#0d0d21', // Very deep, dark blue/black
                        'surface': '#1a1a36', // Darker card background
                        'accent-1': '#00ffff', // NEON CYAN/BLUE (Primary accent)
                        'accent-2': '#ff00aa', // NEON PINK/MAGENTA (Secondary/Alert accent)
                        'sidebar-start': '#0d0d21', // Matches background for smooth sidebar start
                        'sidebar-end': '#4d0099', // Deep Violet/Purple for gradient end
                        'text-light': '#f0f8ff', // Crisp white/azure
                        'text-muted': '#8b8c9d', // Muted gray for secondary text
                        'chart-green': '#39ff14', // NEON LIME GREEN (Success/ROI/PL)
                        // === NEW COLORS ADDED FOR POLAR CHART ===
                        'chart-red': '#ff4d4d',    // Vivid Red for Loss
                        'chart-blue': '#4d4dff',   // Vivid Blue
                        'chart-yellow': '#ffff4d', // Vivid Yellow
                        'chart-purple': '#a020f0', // Purple
                        'chart-orange': '#ffa500', // Orange
                        // =======================================
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Custom scrollbar for dark theme */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1e274a;
        }

        ::-webkit-scrollbar-thumb {
            background: #4c1d95;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #3b82f6;
        }

        #sidebar {
            height: auto;
        }

        /* Ensure the chart container has a defined height */
        .chart-container-lg {
            position: relative;
            height: 400px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
    </style>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // Import necessary Firestore functions for fetching data (if needed)
        import { collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";


        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        window.db = null;
        window.auth = null;

        async function initFirebase() {
            if (!firebaseConfig) {
                console.warn("Firebase config not found. Running in mock data mode.");
                return;
            }
            try {
                setLogLevel('error');
                const app = initializeApp(firebaseConfig);
                window.db = getFirestore(app);
                window.auth = getAuth(app);

                if (initialAuthToken) {
                    await signInWithCustomToken(window.auth, initialAuthToken);
                } else {
                    await signInAnonymously(window.auth);
                }
                // console.log("Firebase initialized and authenticated.");
            } catch (error) {
                console.error("Firebase initialization or sign-in failed:", error);
            }
        }
        window.initFirebase = initFirebase;
    </script>
</head>

<body class="bg-background text-text-light flex min-h-screen relative">

    <div id="sidebar-overlay"
        class="fixed inset-0 bg-background bg-opacity-70 z-40 hidden md:hidden transition-opacity duration-300"
        onclick="toggleSidebar()"></div>

    <div id="sidebar" class="fixed inset-y-0 left-0 z-50 w-64 bg-sidebar-start bg-gradient-to-br from-sidebar-start to-sidebar-end text-white shadow-2xl p-4 
        transform -translate-x-full md:translate-x-0 transition-transform duration-300 
        md:static md:flex md:flex-col md:h-screen">

        <a href="clients.html">
            <div class="flex items-center space-x-3 mb-8 p-2">
                <div class="p-2 rounded-full bg-white bg-opacity-20">
                    <i data-lucide="zap" class="w-6 h-6 text-accent-1"></i>
                </div>
                <h2 class="text-xl font-bold tracking-wider">DASHBOARD</h2>
            </div>
        </a>

        <nav class="space-y-2 flex-grow">
            <a href="dashboard.html"
                class="sidebar-link flex items-center space-x-3 p-3 rounded-xl transition duration-200 hover:bg-white hover:bg-opacity-10">
                <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                <span>Dashboard</span>
            </a>
            <a href="monthly-stats.html"
                class="sidebar-link flex items-center space-x-3 p-3 rounded-xl transition duration-200 hover:bg-white hover:bg-opacity-10">
                <i data-lucide="calendar" class="w-5 h-5"></i>
                <span>Monthly Stats</span>
            </a>
            <a href="league-stats.html"
                class="sidebar-link flex items-center space-x-3 p-3 rounded-xl transition duration-200 hover:bg-white hover:bg-opacity-10">
                <i data-lucide="trophy" class="w-5 h-5"></i>
                <span>League Stats</span>
            </a>
            <a href="m-stats.html" data-page="market-stats"
                class="sidebar-link flex items-center space-x-3 p-3 rounded-xl bg-white bg-opacity-10 font-semibold transition duration-200 hover:bg-opacity-20">
                <i data-lucide="trending-up" class="w-5 h-5"></i>
                <span>Market Stats</span>
            </a>
            <a href="bookmaker-stats.html"
                class="sidebar-link flex items-center space-x-3 p-3 rounded-xl transition duration-200 hover:bg-white hover:bg-opacity-10">
                <i data-lucide="banknote" class="w-5 h-5"></i>
                <span>Bookmaker Stats</span>
            </a>
            <a href="event-stats.html"
                class="sidebar-link flex items-center space-x-3 p-3 rounded-xl transition duration-200 hover:bg-white hover:bg-opacity-10">
                <i data-lucide="calendar-check" class="w-5 h-5"></i>
                <span>Event Stats</span>
            </a>
            <a href="complex-analysis.html"
                class="sidebar-link flex items-center space-x-3 p-3 rounded-xl transition duration-200 hover:bg-white hover:bg-opacity-10">
                <i data-lucide="sigma" class="w-5 h-5"></i>
                <span>Complex Analysis</span>
            </a>
        </nav>

        <div class="mt-auto pt-4 border-t border-white border-opacity-10">
            <a href="#"
                class="flex items-center justify-center p-3 rounded-xl text-xs font-bold uppercase tracking-wider text-text-light bg-accent-2 hover:bg-accent-1/90 transition duration-200">
                <i data-lucide="rocket" class="w-4 h-4 mr-2"></i>
                CREATE PDF
            </a>
        </div>
    </div>

    <div class="flex-1 p-4 md:p-8 overflow-auto">
        <header class="flex justify-between items-center mb-6">
            <button id="menu-toggle" class="md:hidden text-text-light hover:text-accent-1 transition mr-4">
                <i data-lucide="menu" class="w-7 h-7"></i>
            </button>

            <h3 id="profileTitle" class="text-xl sm:text-2xl font-bold tracking-wider text-accent-1 flex-1">MARKET GROUP STATISTICS</h3>

            <div class="flex items-center space-x-4">
                <button class="text-text-muted hover:text-white transition"><i data-lucide="search"
                        class="w-5 h-5"></i></button>
                <button class="text-text-muted hover:text-white transition"><i data-lucide="settings"
                        class="w-5 h-5"></i></button>
                <div class="w-8 h-8 rounded-full bg-gray-500"></div>
            </div>
        </header>

        <main class="space-y-6">
            
            <div class="bg-surface rounded-xl shadow-2xl p-6 border border-accent-1/20">
                <h2 class="text-lg font-semibold text-text-light mb-4">Market Group Performance Analysis (Fixed Stake vs. Fixed ROI)</h2>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    
                    <div class="chart-container-lg">
                        <canvas id="marketGroupStakeChart" class="max-w-full max-h-full"></canvas>
                    </div>

                    <div class="chart-container-lg">
                        <canvas id="marketGroupPLChart" class="max-w-full max-h-full"></canvas>
                    </div>

                </div>
            </div>
            <!-- <div class="bg-surface rounded-xl shadow-2xl p-6 border border-accent-1/20">
                <h2 class="text-lg font-semibold text-text-light mb-4">Win/Loss/Void Count by League on Corners Over/Under</h2>
                <div class="relative h-96">
                    <canvas id="leagueStatsChart"></canvas>
                </div>
            </div>

            <div class="bg-surface rounded-xl shadow-2xl p-6 border border-accent-1/20">
                <h2 class="text-lg font-semibold text-text-light mb-4">Win/Loss/Void Count by League on Cards Over/Under</h2>
                <div class="relative h-96">
                    <canvas id="leagueCardsStatsChart"></canvas>
                </div>
            </div> -->
            <div class="bg-surface rounded-xl shadow-2xl p-6 border border-accent-1/20">
                <h2 class="text-lg font-semibold text-text-light mb-4">Market Corners Performance Analysis (Fixed Stake vs. Fixed ROI)</h2>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    
                    <div class="chart-container-lg">
                        <canvas id="marketCornersStakeChart" class="max-w-full max-h-full"></canvas>
                    </div>

                    <div class="chart-container-lg">
                        <canvas id="marketCornersPLChart" class="max-w-full max-h-full"></canvas>
                    </div>

                </div>
            </div>

             <div class="bg-surface rounded-xl shadow-2xl p-6 border border-accent-1/20">
                <h2 class="text-lg font-semibold text-text-light mb-4">Market Cards Performance Analysis (Fixed Stake vs. Fixed ROI)</h2>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    
                    <div class="chart-container-lg">
                        <canvas id="marketCardsStakeChart" class="max-w-full max-h-full"></canvas>
                    </div>

                    <div class="chart-container-lg">
                        <canvas id="marketCardsPLChart" class="max-w-full max-h-full"></canvas>
                    </div>

                </div>
            </div>
        </main>
    </div>

    <script>
        // --- Sidebar Toggling Logic for Mobile (Unchanged) ---
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            const isHidden = sidebar.classList.contains('-translate-x-full');

            if (isHidden) {
                sidebar.classList.remove('-translate-x-full');
                sidebar.classList.add('translate-x-0');
                overlay.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
            } else {
                sidebar.classList.add('-translate-x-full');
                sidebar.classList.remove('translate-x-0');
                overlay.classList.add('hidden');
                document.body.style.overflow = 'auto';
            }
        }

        window.currentProfile = "User"; 

        function updateSidebarLinks(profile) {
            if (!profile) return; 

            const links = document.querySelectorAll('#sidebar nav a');

            links.forEach(link => {
                let originalHref = link.getAttribute('href');

                if (originalHref && originalHref.endsWith('.html')) {
                    const cleanHref = originalHref.split('?')[0];
                    link.setAttribute('href', `${cleanHref}?profile=${encodeURIComponent(profile)}`);
                } 
            });
        }
        
        // --- Chart Data & Logic ---

        /**
         * Generates mock data for the league stats chart (bar chart).
         */
        function generateMockData() {
            const leagues = ["EPL", "La Liga", "Bundesliga", "Serie A", "Ligue 1", "MLS", "BrasileirÃ£o", "A-League"];
            const data = {
                Win: [],
                Loss: [],
                Void: [],
                Labels: leagues
            };

            leagues.forEach(() => {
                const total = Math.floor(Math.random() * 80) + 20; 
                let win = Math.floor(Math.random() * total * 0.5); 
                let loss = Math.floor(Math.random() * (total - win) * 0.7); 
                let voidCount = total - win - loss; 

                data.Win.push(win);
                data.Loss.push(loss);
                data.Void.push(voidCount);
            });

            return data;
        }

        // ======================================================================
        // === MARKET GROUP MOCK DATA ===
        // ======================================================================
        /**
         * Generates mock data for the market group ROI and Stake (polar area charts).
         * NOTE: ROI values are used to calculate the P/L values.
         */
        function generateMarketGroupMockData() {
             return [
                { "marketGroup": "Cards Over/Under", "roi": 15.5, "totalStake": 4411219.61 }, // PL ~ 683K
                { "marketGroup": "Handicap Corners", "roi": 2.1, "totalStake": 3863167.07 }, // PL ~ 81K
                { "marketGroup": "Corners Over/Under", "roi": -5.3, "totalStake": 3778123.42 }, // PL ~ -200K
                { "marketGroup": "Handicap Cards", "roi": 8.0, "totalStake": 1340407.02 }, // PL ~ 107K
                { "marketGroup": "Team Corners O/U", "roi": -1.8, "totalStake": 844932.26 }, // PL ~ -15K
                { "marketGroup": "Team Cards O/U", "roi": 25.0, "totalStake": 670089.34 }, // PL ~ 167K
                { "marketGroup": "Handicaps", "roi": 5.9, "totalStake": 316207.00 }, // PL ~ 18K
                { "marketGroup": "Other Betting Options", "roi": 12.5, "totalStake": 133572.60 }, // PL ~ 16K
                { "marketGroup": "Combination Markets", "roi": 40.0, "totalStake": 4750.00 }, // PL ~ 1.9K
            ];
        }


        // ======================================================================
        // API FETCH FUNCTIONS (Unchanged from previous versions)
        // ======================================================================

        /**
         * Fetches league stats for CORNERS from the API endpoint and handles error/mock fallback.
         */
        async function fetchCornersStats(profileId) {
            const encodedProfileId = encodeURIComponent(profileId);
            const apiEndpoint = `https://hippophagous-encouragedly-gwyneth.ngrok-free.dev/corners-ou-winlose?client1=${encodedProfileId}`; 

            const requestOptions = {
                method: "GET",
                headers: {
                    "ngrok-skip-browser-warning": "true", 
                    "Accept": "application/json" 
                }
            };
            
            let rawData = null;
            let finalData = null;
            let isMock = false;

            try {
                console.log(`Attempting to fetch CORNERS data from: ${apiEndpoint}`);
                const response = await fetch(apiEndpoint, requestOptions);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                rawData = await response.json();
                
                if (Array.isArray(rawData) && rawData.length === 1) {
                    finalData = rawData[0]; 
                } else {
                    throw new Error("CORNERS API returned unexpected data format.");
                }
                
            } catch (error) {
                console.error("Critical Fetch Error for Corners Stats:", error.message);
                console.warn("Falling back to mock data for Corners.");
                
                finalData = generateMockData();
                isMock = true;
            }
            return { data: finalData, isMock: isMock };
        }

        /**
         * Fetches league stats for CARDS from the API endpoint and handles error/mock fallback.
         */
        async function fetchCardsStats(profileId) {
            const encodedProfileId = encodeURIComponent(profileId);
            const apiEndpoint = `https://hippophagous-encouragedly-gwyneth.ngrok-free.dev/cards-ou-winlose?client1=${encodedProfileId}`; 

            const requestOptions = {
                method: "GET",
                headers: {
                    "ngrok-skip-browser-warning": "true", 
                    "Accept": "application/json" 
                }
            };
            
            let rawData = null;
            let finalData = null;
            let isMock = false;

            try {
                console.log(`Attempting to fetch CARDS data from: ${apiEndpoint}`);
                const response = await fetch(apiEndpoint, requestOptions);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                rawData = await response.json();
                
                if (Array.isArray(rawData) && rawData.length === 1) {
                    finalData = rawData[0]; 
                } else {
                    throw new Error("CARDS API returned unexpected data format.");
                }
                
            } catch (error) {
                console.error("Critical Fetch Error for Cards Stats:", error.message);
                console.warn("Falling back to mock data for Cards.");
                
                finalData = generateMockData();
                isMock = true;
            }
            return { data: finalData, isMock: isMock };
        }

        /**
         * Fetches market group stats for the Polar Area Chart.
         */
        async function fetchMarketGroupStats(profileId) {
            const encodedProfileId = encodeURIComponent(profileId);
            const apiEndpoint = `https://hippophagous-encouragedly-gwyneth.ngrok-free.dev/marketgroup-stats-fixed?client1=${encodedProfileId}`; 

            const requestOptions = {
                method: "GET",
                headers: {
                    "ngrok-skip-browser-warning": "true", 
                    "Accept": "application/json" 
                }
            };
            
            let finalData = null;
            let isMock = false;

            try {
                console.log(`Attempting to fetch Market Group data from: ${apiEndpoint}`);
                const response = await fetch(apiEndpoint, requestOptions);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                const rawData = await response.json();
                
                if (Array.isArray(rawData)) {
                    if (rawData.length === 0) {
                        console.warn("Market Group API returned an empty array. Falling back to mock data.");
                        finalData = generateMarketGroupMockData();
                        isMock = true;
                    } else {
                        finalData = rawData; 
                    }
                } else {
                    throw new Error("Market Group API returned unexpected data format (not an array).");
                }
                
            } catch (error) {
                console.error("Critical Fetch Error for Market Group Stats:", error.message);
                console.warn("Falling back to mock data for Market Groups.");
                
                finalData = generateMarketGroupMockData();
                isMock = true;
            }
            return { data: finalData, isMock: isMock };
        }


        // ======================================================================
        // CHART RENDERING FUNCTIONS
        // ======================================================================
        
        /**
         * Renders a stacked bar chart based on the provided data object.
         */
        function createStackedBarChart(data, canvasId, title) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            
            const colors = tailwind.config.theme.extend.colors;
            const primaryWinColor = colors['chart-green']; 
            const primaryLossColor = colors['accent-2']; 
            const primaryVoidColor = colors['accent-1']; 
            let chartData = data.data;

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: chartData.Labels,
                    datasets: [
                        {
                            label: 'Loss Count',
                            data: chartData.Loss,
                            backgroundColor: primaryLossColor,
                            hoverBackgroundColor: primaryLossColor + 'aa', 
                        },
                        {
                            label: 'Void Count',
                            data: chartData.Void,
                            backgroundColor: primaryVoidColor,
                            hoverBackgroundColor: primaryVoidColor + 'aa',
                        },
                        {
                            label: 'Win Count',
                            data: chartData.Win,
                            backgroundColor: primaryWinColor,
                            hoverBackgroundColor: primaryWinColor + 'aa',
                        },
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false, 
                    plugins: {
                        legend: {
                            labels: {
                                color: colors['text-light'],
                                boxWidth: 10,
                                padding: 5,
                            }
                        },
                        tooltip: {
                            backgroundColor: colors['surface'],
                            titleColor: colors['text-light'],
                            bodyColor: colors['text-light'],
                            borderColor: colors['accent-1'],
                            borderWidth: 1,
                        },
                        title: {
                             display: true,
                             text: title, 
                             font: {
                                 size: 16,
                                 weight: 'bold'
                             },
                             color: colors['text-light']
                        }
                    },
                    scales: {
                        x: {
                            stacked: true,
                            grid: { display: false },
                            ticks: { color: colors['text-muted'], },
                            title: { display: true, text: 'League', color: colors['text-light'] }
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            grid: {
                                color: colors['surface'], 
                                borderColor: colors['text-muted'],
                            },
                            ticks: { color: colors['text-muted'], stepSize: 20 },
                            title: { display: true, text: 'Count', color: colors['text-light'] }
                        }
                    }
                }
            });
        }


        // ======================================================================
        // === DUAL CHARTS: MARKET GROUP STAKE (Polar) & PL (Horizontal Bar) ===
        // ======================================================================
        /**
         * Renders two side-by-side charts for Market Group Stake (Polar) and P/L (Bar).
         */
        function createDualMarketGroupCharts(data) {
            const rawData = data.data;
            const colors = tailwind.config.theme.extend.colors;

          
            let mr_events = rawData.map(item => item.events);
            const labels = rawData.map(item => item.marketGroup.split("_")[1]);
            const stakes = rawData.map(item => item.totalStake);
            const rois = rawData.map(item => item.roi);
            
            // Calculate Profit/Loss (PL) for each market group (SIGNED VALUE)
            const pls = rawData.map(item => (item.totalStake * item.roi / 100));

             let totalStake = stakes.reduce((a, b) => a + b, 0);
             let totalPls = pls.reduce((a, b) => a + b, 0);
             let totalRoi = totalPls / totalStake * 100;


             console.log({totalStake: totalStake})
             console.log({totalPl: totalPls})
             console.log({totalRoi: totalRoi})
            
             let uniqueEvents = [];
             for (const mark of mr_events) {
                for (const event of mark) {
                    let eventspl = event.eventTag2.split("_");
                    let eventName = eventspl[0] + " vs " +  eventspl[1] + " -- " + eventspl[3] + ", Odd: " + event.oddNum + ", Eval: " + event.eval;
                    uniqueEvents.push({date: event.eventTag.split("__")[3],home: eventspl[0], away: eventspl[1], marketGr: eventspl[3], odd: event.oddNum, eval: event.eval, pl: event.plFixed});
                }
             }
             console.log(JSON.stringify(uniqueEvents));
            const colorPalette = [
                colors['chart-green'], colors['accent-2'], colors['chart-blue'], colors['chart-red'], 
                colors['chart-yellow'], colors['chart-purple'], colors['chart-orange'], '#0099ff', '#99ff00', '#ff0099'
            ];
            
            const backgroundColors = labels.map((_, index) => colorPalette[index % colorPalette.length]);

            // Helper for formatting large numbers and ROI/PL
            const formatValue = (value, type) => {
                const floatValue = parseFloat(value);
                if (type === 'ROI') return `${floatValue.toFixed(2)}%`; 
                
                // For Stake (STAKE) or P/L (PL) - Format as currency/large number
                const sign = floatValue < 0 ? '-' : '';
                const absValue = Math.abs(floatValue);

                if (absValue >= 1000000) return `${sign}${(absValue / 1000000).toFixed(1)}M`;
                if (absValue >= 1000) return `${sign}${(absValue / 1000).toFixed(0)}K`;
                return `${sign}${absValue.toFixed(2)}`;
            };

            // --- 1. STAKE CHART CONFIGURATION (Polar Area - Unchanged) ---
            const stakeCtx = document.getElementById('marketGroupStakeChart').getContext('2d');
            const stakeChartData = {
                labels: labels,
                datasets: [{
                    label: 'Total Stake',
                    data: stakes, // Use raw stake value for magnitude
                    backgroundColor: backgroundColors.map(color => color + 'b3'), 
                    borderColor: colors['surface'], 
                    borderWidth: 2
                }],
            };
            
            // Common options for Polar Area
            const polarCommonOptions = {
                responsive: true,
                maintainAspectRatio: false,
                scale: {
                    grid: {
                        color: colors['text-muted'] + '22',
                    },
                    ticks: {
                        backdropColor: colors['surface'], 
                        color: colors['text-muted'],
                        font: { size: 12 },
                        z: 2 
                    },
                },
                plugins: {
                    legend: {
                        position: 'bottom', 
                        labels: {
                            color: colors['text-light'],
                            boxWidth: 10,
                        }
                    },
                    tooltip: {
                        backgroundColor: colors['surface'],
                        titleColor: colors['text-light'],
                        bodyColor: colors['text-light'],
                        borderColor: colors['accent-1'],
                        borderWidth: 1,
                        callbacks: {
                            label: function(context) {
                                const marketGroup = context.label;
                                const roi = rois[context.dataIndex];
                                const stake = stakes[context.dataIndex];
                                const pl = pls[context.dataIndex];
                                
                                return `${marketGroup}: Stake ${formatValue(stake, 'STAKE')} | P/L ${formatValue(pl, 'PL')} | ROI ${formatValue(roi, 'ROI')}`;
                            }
                        }
                    }
                }
            };

            // --- 2. P/L CHART CONFIGURATION (Horizontal Bar - NEW) ---
            const plCtx = document.getElementById('marketGroupPLChart').getContext('2d');
            const plBackgroundColors = pls.map(pl => pl >= 0 ? colors['chart-green'] : colors['chart-red']);
            const plChartData = {
                labels: labels,
                datasets: [{
                    label: 'ROI',
                    data: rois, // Use the signed PL data
                    backgroundColor: plBackgroundColors, 
                    borderColor: plBackgroundColors.map(c => c + 'aa'), // Slightly darker border
                    borderWidth: 1
                }],
            };

            // Options for Horizontal Bar Chart
            const barCommonOptions = {
                indexAxis: 'y', // Make it horizontal
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false // Hide the legend for simplicity
                    },
                    title: { 
                        display: true, 
                        text: 'ROI per Market Group', 
                        font: { size: 16, weight: 'bold' }, 
                        color: colors['text-light'] 
                    },
                    tooltip: {
                        backgroundColor: colors['surface'],
                        titleColor: colors['text-light'],
                        bodyColor: colors['text-light'],
                        borderColor: colors['accent-1'],
                        borderWidth: 1,
                        callbacks: {
                            label: function(context) {
                                const marketGroup = context.label;
                               const stake = stakes[context.dataIndex];
                                const pl = pls[context.dataIndex];
                                const roi = rois[context.dataIndex];
                                return `${marketGroup} Stake: ${formatValue(stake, 'STAKE')} | P/L: ${formatValue(pl, 'PL')} | ROI: ${formatValue(roi, 'ROI')}`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        position: 'bottom',
                        grid: { color: colors['text-muted'] + '22' },
                        ticks: { color: colors['text-muted'], callback: function(value) { return formatValue(value, 'PL'); } },
                        title: { display: true, text: 'ROI', color: colors['text-light'] }
                    },
                    y: {
                        grid: { display: false },
                        ticks: { color: colors['text-light'] }
                    }
                }
            };
            
            // Create the charts
            new Chart(stakeCtx, {
                type: 'polarArea',
                data: stakeChartData,
                options: { ...polarCommonOptions, plugins: { ...polarCommonOptions.plugins, title: { display: true, text: 'Stake per Market Group', color: colors['text-light'] } } },
            });

            new Chart(plCtx, {
                type: 'bar', // Change type to 'bar'
                data: plChartData,
                options: barCommonOptions,
            });
        }


        /** Application startup function. */
        async function initializeApp() {
            // Read profile from URL and update sidebar links
            const params = new URLSearchParams(window.location.search);
            const profile = params.get("profile") || "User";
            window.currentProfile = profile; 
            updateSidebarLinks(profile);

            // Update title
            document.getElementById("profileTitle").innerText = `${profile}'s Market Stats`;
            
            // Initialize Lucide icons
            lucide.createIcons();

            // Initialize Firebase (and sign-in)
            await window.initFirebase(); 

            // --- Data Fetching and Chart Creation ---

            // 1. Fetch and render DUAL MARKET GROUP STAKE/PL charts
            const marketGroupData = await fetchMarketGroupStats(profile);
            createDualMarketGroupCharts(marketGroupData);
            
            // // 2. Fetch and render CORNERS chart (EXISTING)
            // const cornersData = await fetchCornersStats(profile);
            // createStackedBarChart(cornersData, 'leagueStatsChart', 'Win/Loss/Void Count by League on Corners Over/Under');
            
            // // 3. Fetch and render CARDS chart (EXISTING)
            // const cardsData = await fetchCardsStats(profile);
            // createStackedBarChart(cardsData, 'leagueCardsStatsChart', 'Win/Loss/Void Count by League on Cards Over/Under');

            // 2. Fetch and render DUAL Market Corners Stake/PL charts
            const marketGroupCorners = await fetchMarketGroupCorners(profile);
            createDualMarketCornersCharts(marketGroupCorners);

            // 3. Fetch and render DUAL Market Cards Stake/PL charts
            const marketGroupCards = await fetchMarketGroupCards(profile);
            createDualMarketCardsCharts(marketGroupCards);


            // Set up Event Listeners
            document.getElementById('menu-toggle').addEventListener('click', toggleSidebar);

            // Close sidebar on link click (for mobile)
            document.querySelectorAll('.sidebar-link').forEach(link => {
                link.addEventListener('click', () => {
                    if (window.innerWidth < 768) {
                        toggleSidebar();
                    }
                });
            });
            
            console.log("Market Stats page initialized.");
        }

        // Initialize the app when the DOM is ready
        document.addEventListener('DOMContentLoaded', initializeApp);


        function createDualMarketCornersCharts(data) {
            const rawData = data.data;
            const colors = tailwind.config.theme.extend.colors;

          
            let mr_events = rawData.map(item => item.events);
            const labels = rawData.map(item => item.leagueGroup);
            const stakes = rawData.map(item => item.totalStake);
            const rois = rawData.map(item => item.roi);
            
            // Calculate Profit/Loss (PL) for each market group (SIGNED VALUE)
            const pls = rawData.map(item => (item.totalStake * item.roi / 100));

             let totalStake = stakes.reduce((a, b) => a + b, 0);
             let totalPls = pls.reduce((a, b) => a + b, 0);
             let totalRoi = totalPls / totalStake * 100;


             console.log({totalStake: totalStake})
             console.log({totalPl: totalPls})
             console.log({totalRoi: totalRoi})
            
             let uniqueEvents = [];
             for (const mark of mr_events) {
                for (const event of mark) {
                    let eventspl = event.eventTag2.split("_");
                    let eventName = eventspl[0] + " vs " +  eventspl[1] + " -- " + eventspl[3] + ", Odd: " + event.oddNum + ", Eval: " + event.eval;
                    uniqueEvents.push({date: event.eventTag.split("__")[3],home: eventspl[0], away: eventspl[1], marketGr: eventspl[3], odd: event.oddNum, eval: event.eval, pl: event.plFixed});
                }
             }
             console.log(JSON.stringify(uniqueEvents));
            const colorPalette = [
                colors['chart-green'], colors['accent-2'], colors['chart-blue'], colors['chart-red'], 
                colors['chart-yellow'], colors['chart-purple'], colors['chart-orange'], '#0099ff', '#99ff00', '#ff0099'
            ];
            
            const backgroundColors = labels.map((_, index) => colorPalette[index % colorPalette.length]);

            // Helper for formatting large numbers and ROI/PL
            const formatValue = (value, type) => {
                const floatValue = parseFloat(value);
                if (type === 'ROI') return `${floatValue.toFixed(2)}%`; 
                
                // For Stake (STAKE) or P/L (PL) - Format as currency/large number
                const sign = floatValue < 0 ? '-' : '';
                const absValue = Math.abs(floatValue);

                if (absValue >= 1000000) return `${sign}${(absValue / 1000000).toFixed(1)}M`;
                if (absValue >= 1000) return `${sign}${(absValue / 1000).toFixed(0)}K`;
                return `${sign}${absValue.toFixed(2)}`;
            };

           // --- 1. STAKE CHART CONFIGURATION (Converted to Bar Chart) ---
            const stakeCtx = document.getElementById('marketCornersStakeChart').getContext('2d');

            const stakeChartData = {
                labels: labels,
                datasets: [{
                    label: 'Total Stake',
                    data: stakes, // Raw stake value
                    backgroundColor: backgroundColors.map(color => color + 'b3'), 
                    borderColor: colors['surface'], 
                    borderWidth: 2,
                    borderRadius: 4, // Optional: rounds the corners of the bars
                }],
            };

            // Updated options for Bar Chart
            const bar1CommonOptions = {
                type: 'bar', // Specify the chart type
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'x', // Change to 'y' if you want a horizontal bar chart
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: colors['text-muted'] + '22',
                            drawBorder: false,
                        },
                        ticks: {
                            color: colors['text-muted'],
                            font: { size: 12 },
                            // Optional: format the Y-axis labels using your helper
                            callback: function(value) {
                                return formatValue(value, 'STAKE');
                            }
                        }
                    },
                    x: {
                        grid: {
                            display: false // Usually looks cleaner without vertical lines
                        },
                        ticks: {
                            color: colors['text-muted'],
                            font: { size: 12 }
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false, // Often redundant for single-dataset bar charts
                        position: 'bottom', 
                        labels: {
                            color: colors['text-light'],
                            boxWidth: 10,
                        }
                    },
                    tooltip: {
                        backgroundColor: colors['surface'],
                        titleColor: colors['text-light'],
                        bodyColor: colors['text-light'],
                        borderColor: colors['accent-1'],
                        borderWidth: 1,
                        padding: 12,
                        callbacks: {
                            label: function(context) {
                                const marketGroup = context.label;
                                const roi = rois[context.dataIndex];
                                const stake = stakes[context.dataIndex];
                                const pl = pls[context.dataIndex];
                                
                                return [
                                    `Stake: ${formatValue(stake, 'STAKE')}`,
                                    `P/L: ${formatValue(pl, 'PL')}`,
                                    `ROI: ${formatValue(roi, 'ROI')}`
                                ];
                            }
                        }
                    }
                }
            };

            // --- 2. P/L CHART CONFIGURATION (Horizontal Bar - NEW) ---
            const plCtx = document.getElementById('marketCornersPLChart').getContext('2d');
            const plBackgroundColors = pls.map(pl => pl >= 0 ? colors['chart-green'] : colors['chart-red']);
            const plChartData = {
                labels: labels,
                datasets: [{
                    label: 'ROI',
                    data: rois, // Use the signed PL data
                    backgroundColor: plBackgroundColors, 
                    borderColor: plBackgroundColors.map(c => c + 'aa'), // Slightly darker border
                    borderWidth: 1
                }],
            };

            // Options for Horizontal Bar Chart
            const barCommonOptions = {
                indexAxis: 'y', // Make it horizontal
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false // Hide the legend for simplicity
                    },
                    title: { 
                        display: true, 
                        text: 'ROI per Market Group', 
                        font: { size: 16, weight: 'bold' }, 
                        color: colors['text-light'] 
                    },
                    tooltip: {
                        backgroundColor: colors['surface'],
                        titleColor: colors['text-light'],
                        bodyColor: colors['text-light'],
                        borderColor: colors['accent-1'],
                        borderWidth: 1,
                        callbacks: {
                            label: function(context) {
                                const marketGroup = context.label;
                               const stake = stakes[context.dataIndex];
                                const pl = pls[context.dataIndex];
                                const roi = rois[context.dataIndex];
                                return `${marketGroup} Stake: ${formatValue(stake, 'STAKE')} | P/L: ${formatValue(pl, 'PL')} | ROI: ${formatValue(roi, 'ROI')}`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        position: 'bottom',
                        grid: { color: colors['text-muted'] + '22' },
                        ticks: { color: colors['text-muted'], callback: function(value) { return formatValue(value, 'PL'); } },
                        title: { display: true, text: 'ROI', color: colors['text-light'] }
                    },
                    y: {
                        grid: { display: false },
                        ticks: { color: colors['text-light'] }
                    }
                }
            };
            
            // To initialize:
            new Chart(stakeCtx, {
                type: 'bar',
                data: stakeChartData,
                options: bar1CommonOptions
            });

            new Chart(plCtx, {
                type: 'bar', // Change type to 'bar'
                data: plChartData,
                options: barCommonOptions,
            });
        }


        function createDualMarketCardsCharts(data) {
            const rawData = data.data;
            const colors = tailwind.config.theme.extend.colors;

          
            let mr_events = rawData.map(item => item.events);
            const labels = rawData.map(item => item.leagueGroup);
            const stakes = rawData.map(item => item.totalStake);
            const rois = rawData.map(item => item.roi);
            
            // Calculate Profit/Loss (PL) for each market group (SIGNED VALUE)
            const pls = rawData.map(item => (item.totalStake * item.roi / 100));

             let totalStake = stakes.reduce((a, b) => a + b, 0);
             let totalPls = pls.reduce((a, b) => a + b, 0);
             let totalRoi = totalPls / totalStake * 100;


             console.log({totalStake: totalStake})
             console.log({totalPl: totalPls})
             console.log({totalRoi: totalRoi})
            
             let uniqueEvents = [];
             for (const mark of mr_events) {
                for (const event of mark) {
                    let eventspl = event.eventTag2.split("_");
                    let eventName = eventspl[0] + " vs " +  eventspl[1] + " -- " + eventspl[3] + ", Odd: " + event.oddNum + ", Eval: " + event.eval;
                    uniqueEvents.push({date: event.eventTag.split("__")[3],home: eventspl[0], away: eventspl[1], marketGr: eventspl[3], odd: event.oddNum, eval: event.eval, pl: event.plFixed});
                }
             }
             console.log(JSON.stringify(uniqueEvents));
            const colorPalette = [
                colors['chart-green'], colors['accent-2'], colors['chart-blue'], colors['chart-red'], 
                colors['chart-yellow'], colors['chart-purple'], colors['chart-orange'], '#0099ff', '#99ff00', '#ff0099'
            ];
            
            const backgroundColors = labels.map((_, index) => colorPalette[index % colorPalette.length]);

            // Helper for formatting large numbers and ROI/PL
            const formatValue = (value, type) => {
                const floatValue = parseFloat(value);
                if (type === 'ROI') return `${floatValue.toFixed(2)}%`; 
                
                // For Stake (STAKE) or P/L (PL) - Format as currency/large number
                const sign = floatValue < 0 ? '-' : '';
                const absValue = Math.abs(floatValue);

                if (absValue >= 1000000) return `${sign}${(absValue / 1000000).toFixed(1)}M`;
                if (absValue >= 1000) return `${sign}${(absValue / 1000).toFixed(0)}K`;
                return `${sign}${absValue.toFixed(2)}`;
            };

           // --- 1. STAKE CHART CONFIGURATION (Converted to Bar Chart) ---
            const stakeCtx = document.getElementById('marketCardsStakeChart').getContext('2d');

            const stakeChartData = {
                labels: labels,
                datasets: [{
                    label: 'Total Stake',
                    data: stakes, // Raw stake value
                    backgroundColor: backgroundColors.map(color => color + 'b3'), 
                    borderColor: colors['surface'], 
                    borderWidth: 2,
                    borderRadius: 4, // Optional: rounds the corners of the bars
                }],
            };

            // Updated options for Bar Chart
            const bar1CommonOptions = {
                type: 'bar', // Specify the chart type
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'x', // Change to 'y' if you want a horizontal bar chart
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: colors['text-muted'] + '22',
                            drawBorder: false,
                        },
                        ticks: {
                            color: colors['text-muted'],
                            font: { size: 12 },
                            // Optional: format the Y-axis labels using your helper
                            callback: function(value) {
                                return formatValue(value, 'STAKE');
                            }
                        }
                    },
                    x: {
                        grid: {
                            display: false // Usually looks cleaner without vertical lines
                        },
                        ticks: {
                            color: colors['text-muted'],
                            font: { size: 12 }
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false, // Often redundant for single-dataset bar charts
                        position: 'bottom', 
                        labels: {
                            color: colors['text-light'],
                            boxWidth: 10,
                        }
                    },
                    tooltip: {
                        backgroundColor: colors['surface'],
                        titleColor: colors['text-light'],
                        bodyColor: colors['text-light'],
                        borderColor: colors['accent-1'],
                        borderWidth: 1,
                        padding: 12,
                        callbacks: {
                            label: function(context) {
                                const marketGroup = context.label;
                                const roi = rois[context.dataIndex];
                                const stake = stakes[context.dataIndex];
                                const pl = pls[context.dataIndex];
                                
                                return [
                                    `Stake: ${formatValue(stake, 'STAKE')}`,
                                    `P/L: ${formatValue(pl, 'PL')}`,
                                    `ROI: ${formatValue(roi, 'ROI')}`
                                ];
                            }
                        }
                    }
                }
            };

            // --- 2. P/L CHART CONFIGURATION (Horizontal Bar - NEW) ---
            const plCtx = document.getElementById('marketCardsPLChart').getContext('2d');
            const plBackgroundColors = pls.map(pl => pl >= 0 ? colors['chart-green'] : colors['chart-red']);
            const plChartData = {
                labels: labels,
                datasets: [{
                    label: 'ROI',
                    data: rois, // Use the signed PL data
                    backgroundColor: plBackgroundColors, 
                    borderColor: plBackgroundColors.map(c => c + 'aa'), // Slightly darker border
                    borderWidth: 1
                }],
            };

            // Options for Horizontal Bar Chart
            const barCommonOptions = {
                indexAxis: 'y', // Make it horizontal
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false // Hide the legend for simplicity
                    },
                    title: { 
                        display: true, 
                        text: 'ROI per Market Group', 
                        font: { size: 16, weight: 'bold' }, 
                        color: colors['text-light'] 
                    },
                    tooltip: {
                        backgroundColor: colors['surface'],
                        titleColor: colors['text-light'],
                        bodyColor: colors['text-light'],
                        borderColor: colors['accent-1'],
                        borderWidth: 1,
                        callbacks: {
                            label: function(context) {
                                const marketGroup = context.label;
                               const stake = stakes[context.dataIndex];
                                const pl = pls[context.dataIndex];
                                const roi = rois[context.dataIndex];
                                return `${marketGroup} Stake: ${formatValue(stake, 'STAKE')} | P/L: ${formatValue(pl, 'PL')} | ROI: ${formatValue(roi, 'ROI')}`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        position: 'bottom',
                        grid: { color: colors['text-muted'] + '22' },
                        ticks: { color: colors['text-muted'], callback: function(value) { return formatValue(value, 'PL'); } },
                        title: { display: true, text: 'ROI', color: colors['text-light'] }
                    },
                    y: {
                        grid: { display: false },
                        ticks: { color: colors['text-light'] }
                    }
                }
            };
            
            // To initialize:
            new Chart(stakeCtx, {
                type: 'bar',
                data: stakeChartData,
                options: bar1CommonOptions
            });

            new Chart(plCtx, {
                type: 'bar', // Change type to 'bar'
                data: plChartData,
                options: barCommonOptions,
            });
        }


        async function fetchMarketGroupCorners(profileId) {
            const encodedProfileId = encodeURIComponent(profileId);
            const apiEndpoint = `https://hippophagous-encouragedly-gwyneth.ngrok-free.dev/corners-stats-fixed?client1=${encodedProfileId}`; 

            const requestOptions = {
                method: "GET",
                headers: {
                    "ngrok-skip-browser-warning": "true", 
                    "Accept": "application/json" 
                }
            };
            
            let finalData = null;
            let isMock = false;

            try {
                console.log(`Attempting to fetch Market Group data from: ${apiEndpoint}`);
                const response = await fetch(apiEndpoint, requestOptions);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                const rawData = await response.json();
                
                if (Array.isArray(rawData)) {
                    if (rawData.length === 0) {
                        console.warn("Market Group API returned an empty array. Falling back to mock data.");
                        finalData = generateMarketGroupMockData();
                        isMock = true;
                    } else {
                        finalData = rawData; 
                    }
                } else {
                    throw new Error("Market Group API returned unexpected data format (not an array).");
                }
                
            } catch (error) {
                console.error("Critical Fetch Error for Market Group Stats:", error.message);
                console.warn("Falling back to mock data for Market Groups.");
                
                finalData = generateMarketGroupMockData();
                isMock = true;
            }
            return { data: finalData, isMock: isMock };
        }

        async function fetchMarketGroupCards(profileId) {
            const encodedProfileId = encodeURIComponent(profileId);
            const apiEndpoint = `https://hippophagous-encouragedly-gwyneth.ngrok-free.dev/cards-stats-fixed?client1=${encodedProfileId}`; 

            const requestOptions = {
                method: "GET",
                headers: {
                    "ngrok-skip-browser-warning": "true", 
                    "Accept": "application/json" 
                }
            };
            
            let finalData = null;
            let isMock = false;

            try {
                console.log(`Attempting to fetch Market Group data from: ${apiEndpoint}`);
                const response = await fetch(apiEndpoint, requestOptions);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                const rawData = await response.json();
                
                if (Array.isArray(rawData)) {
                    if (rawData.length === 0) {
                        console.warn("Market Group API returned an empty array. Falling back to mock data.");
                        finalData = generateMarketGroupMockData();
                        isMock = true;
                    } else {
                        finalData = rawData; 
                    }
                } else {
                    throw new Error("Market Group API returned unexpected data format (not an array).");
                }
                
            } catch (error) {
                console.error("Critical Fetch Error for Market Group Stats:", error.message);
                console.warn("Falling back to mock data for Market Groups.");
                
                finalData = generateMarketGroupMockData();
                isMock = true;
            }
            return { data: finalData, isMock: isMock };
        }
    </script>
</body>
</html>