<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- Load Moment.js for date handling -->
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
    <!-- Load Lucide icons (open-source vector icons) -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'background': '#0d0d21',   // Very deep, dark blue/black
                        'surface': '#1a1a36',      // Darker card background
                        'accent-1': '#00ffff',     // NEON CYAN/BLUE (Primary accent)
                        'accent-2': '#ff00aa',     // NEON PINK/MAGENTA (Secondary/Alert accent)
                        'sidebar-start': '#0d0d21',// Matches background for smooth sidebar start
                        'sidebar-end': '#4d0099',  // Deep Violet/Purple for gradient end
                        'text-light': '#f0f8ff',   // Crisp white/azure
                        'text-muted': '#8b8c9d',   // Muted gray for secondary text
                        'chart-green': '#39ff14',  // NEON LIME GREEN (Success/ROI)
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Custom scrollbar for dark theme */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1e274a;
        }

        ::-webkit-scrollbar-thumb {
            background: #4c1d95;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #3b82f6;
        }

        #sidebar {
            height: auto;
        }
        .text-accent-1 {
            color: #00ffff !important;
        }
    </style>
    <!-- Firebase/Firestore boilerplate -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        window.db = null;
        window.auth = null;

        async function initFirebase() {
            if (!firebaseConfig) {
                console.warn("Firebase config not found. Running in mock data mode.");
                return;
            }
            try {
                setLogLevel('error');
                const app = initializeApp(firebaseConfig);
                window.db = getFirestore(app);
                window.auth = getAuth(app);

                if (initialAuthToken) {
                    await signInWithCustomToken(window.auth, initialAuthToken);
                } else {
                    await signInAnonymously(window.auth);
                }
                // console.log("Firebase initialized and authenticated.");
            } catch (error) {
                console.error("Firebase initialization or sign-in failed:", error);
            }
        }
        window.initFirebase = initFirebase;
    </script>
</head>

<body class="bg-background text-text-light flex min-h-screen relative">

    <!-- Mobile Sidebar Overlay (Visible only on small screens when menu is open) -->
    <div id="sidebar-overlay"
        class="fixed inset-0 bg-background bg-opacity-70 z-40 hidden md:hidden transition-opacity duration-300"
        onclick="toggleSidebar()"></div>

    <!-- Sidebar (Now uses fixed positioning for mobile off-canvas behavior) -->
    <div id="sidebar" class="fixed inset-y-0 left-0 z-50 w-64 bg-sidebar-start bg-gradient-to-br from-sidebar-start to-sidebar-end text-white shadow-2xl p-4 
        transform -translate-x-full md:translate-x-0 transition-transform duration-300 
        md:static md:flex md:flex-col md:h-screen">

        <a href="clients.html">
            <div class="flex items-center space-x-3 mb-8 p-2">
                <div class="p-2 rounded-full bg-white bg-opacity-20">
                    <i data-lucide="zap" class="w-6 h-6 text-accent-1"></i>
                </div>
                <h2 class="text-xl font-bold tracking-wider">DASHBOARD</h2>
            </div>
        </a>

        <nav class="space-y-2 flex-grow">
            <!-- Navigation Links -->
            <a href="#"
                class="sidebar-link flex items-center space-x-3 p-3 rounded-xl bg-white bg-opacity-10 font-semibold transition duration-200 hover:bg-opacity-20">
                <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                <span>Dashboard</span>
            </a>
            <a href="#"
                class="sidebar-link flex items-center space-x-3 p-3 rounded-xl transition duration-200 hover:bg-white hover:bg-opacity-10">
                <i data-lucide="calendar" class="w-5 h-5"></i>
                <span>Monthly Stats</span>
            </a>
            <a href="#"
                class="sidebar-link flex items-center space-x-3 p-3 rounded-xl transition duration-200 hover:bg-white hover:bg-opacity-10">
                <i data-lucide="trophy" class="w-5 h-5"></i>
                <span>League Stats</span>
            </a>
            <a href="m-stats.html?profile=" data-page="market-stats"
                class="sidebar-link flex items-center space-x-3 p-3 rounded-xl transition duration-200 hover:bg-white hover:bg-opacity-10">
                <i data-lucide="trending-up" class="w-5 h-5"></i>
                <span>Market Stats</span>
            </a>
            <a href="#"
                class="sidebar-link flex items-center space-x-3 p-3 rounded-xl transition duration-200 hover:bg-white hover:bg-opacity-10">
                <i data-lucide="banknote" class="w-5 h-5"></i>
                <span>Bookmaker Stats</span>
            </a>
            <a href="#"
                class="sidebar-link flex items-center space-x-3 p-3 rounded-xl transition duration-200 hover:bg-white hover:bg-opacity-10">
                <i data-lucide="calendar-check" class="w-5 h-5"></i>
                <span>Event Stats</span>
            </a>
            <a href="#"
                class="sidebar-link flex items-center space-x-3 p-3 rounded-xl transition duration-200 hover:bg-white hover:bg-opacity-10">
                <i data-lucide="sigma" class="w-5 h-5"></i>
                <span>Complex Analysis</span>
            </a>
        </nav>

        <div class="mt-auto pt-4 border-t border-white border-opacity-10">
            <a href="#"
                class="flex items-center justify-center p-3 rounded-xl text-xs font-bold uppercase tracking-wider text-text-light bg-accent-2 hover:bg-accent-1/90 transition duration-200">
                <i data-lucide="rocket" class="w-4 h-4 mr-2"></i>
                CREATE PDF
            </a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="flex-1 p-4 md:p-8 overflow-auto">
        <!-- Top Header & Controls -->
        <header class="flex justify-between items-center mb-6">
            <!-- Mobile Menu Toggle Button (Hamburger) -->
            <button id="menu-toggle" class="md:hidden text-text-light hover:text-accent-1 transition mr-4">
                <i data-lucide="menu" class="w-7 h-7"></i>
            </button>

            <h3 id="profileTitle" class="text-xl sm:text-2xl font-bold tracking-wider text-accent-1 flex-1">DASHBOARD</h3>

            <div class="flex items-center space-x-4">
                <button class="text-text-muted hover:text-white transition"><i data-lucide="search"
                        class="w-5 h-5"></i></button>
                <button class="text-text-muted hover:text-white transition"><i data-lucide="settings"
                        class="w-5 h-5"></i></button>
                <div class="w-8 h-8 rounded-full bg-gray-500"></div>
            </div>
        </header>

        <!-- Main Chart Section (STAKE/PL/ROI) -->
        <div class="bg-surface rounded-xl shadow-2xl p-4 md:p-6 mb-8 border border-surface/50">

            <div
                class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 border-b border-white border-opacity-10 pb-4">
                <div class="flex flex-wrap items-center space-x-2 mb-3 sm:mb-0">
                    <h2 class="text-xl font-bold text-text-light" id="main-chart-title">STAKE</h2>
                    <!-- Tab Switcher -->
                    <div id="main-tabs"
                        class="inline-flex rounded-full bg-background p-1 text-sm text-text-muted mt-2 sm:mt-0">
                        <button data-tab="stake"
                            class="tab-btn px-4 py-1 rounded-full font-semibold transition-colors duration-200 bg-accent-1 text-white shadow-lg">Stake</button>
                        <button data-tab="pl"
                            class="tab-btn px-4 py-1 rounded-full font-semibold transition-colors duration-200 hover:text-white">PL</button>
                        <button data-tab="roi"
                            class="tab-btn px-4 py-1 rounded-full font-semibold transition-colors duration-200 hover:text-white">ROI</button>
                    </div>
                </div>

                <!-- Time View Selector -->
                <div id="view-selector" class="inline-flex rounded-full bg-background p-1 text-xs text-text-muted">
                    <button data-view="year"
                        class="view-btn px-3 py-1 rounded-full font-semibold transition-colors duration-200 bg-surface/50 text-white">Season</button>
                    <button data-view="week"
                        class="view-btn px-3 py-1 rounded-full font-semibold transition-colors duration-200 hover:bg-surface/50 hover:text-white">Weekly</button>
                    <button data-view="month"
                        class="view-btn px-3 py-1 rounded-full font-semibold transition-colors duration-200 hover:bg-surface/50 hover:text-white">Daily</button>
                    <!-- <button data-view="day" class="view-btn px-3 py-1 rounded-full font-semibold transition-colors duration-200 hover:bg-surface/50 hover:text-white">Day</button> -->
                </div>
            </div>

            <div class="relative h-72 lg:h-96">
                <canvas id="mainChart"></canvas>
            </div>
        </div>

        <!-- Three Small Charts Section (Responsive Grid) -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">

            <!-- Chart 1: Events per Week (Line Chart) -->
            <div class="bg-surface rounded-xl p-4 shadow-xl border border-surface/50">
                <div class="flex items-center space-x-3 mb-3">
                    <div class="p-2 rounded-full bg-accent-1/20 text-accent-1">
                        <i data-lucide="calendar-heart" class="w-5 h-5"></i>
                    </div>
                    <h3 class="text-text-muted text-sm font-semibold">Total Events Tracked</h3>
                </div>
                <p class="text-2xl font-extrabold text-white mb-2" id="total-events-count">...</p>
                <div class="relative h-32">
                    <canvas id="eventsPerWeekChart"></canvas>
                </div>
            </div>

            <!-- Chart 2: Total Stake per Market Group (Bar Chart) -->
            <div class="bg-surface rounded-xl p-4 shadow-xl border border-surface/50">
                <div class="flex items-center space-x-3 mb-3">
                    <div class="p-2 rounded-full bg-accent-2/20 text-accent-2">
                        <i data-lucide="banknote" class="w-5 h-5"></i>
                    </div>
                    <h3 class="text-text-muted text-sm font-semibold">Stake per Market Group</h3>
                </div>
                <p class="text-2xl font-extrabold text-white mb-2">$ 8,500 <span
                        class="text-text-muted text-sm font-normal"> (Weekly Avg)</span></p>
                <div class="relative h-32">
                    <canvas id="stakePerMarketChart"></canvas>
                </div>
            </div>

            <!-- Chart 3: Total ROI per Market Group (Bar Chart) -->
            <div class="bg-surface rounded-xl p-4 shadow-xl border border-surface/50 lg:col-span-1 md:col-span-2">
                <div class="flex items-center space-x-3 mb-3">
                    <div class="p-2 rounded-full bg-chart-green/20 text-chart-green">
                        <i data-lucide="percent" class="w-5 h-5"></i>
                    </div>
                    <h3 class="text-text-muted text-sm font-semibold">ROI per Market Group</h3>
                </div>
                <p class="text-2xl font-extrabold text-white mb-2">15.2% <span
                        class="text-text-muted text-sm font-normal"> (Avg ROI)</span></p>
                <div class="relative h-32">
                    <canvas id="roiPerMarketChart"></canvas>
                </div>
            </div>
        </div>

    </div>

    <!-- Chart and Interaction Logic -->
 <script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.30.1/moment.min.js"></script>

<script>
    // Configure Tailwind to enable custom colors used in the chart logic
    tailwind.config = {
        theme: {
            extend: {
                colors: {
                    'background': '#0a0d18',
                    'surface': '#1c223a',
                    'accent-1': '#6c63ff',
                    'accent-2': '#ff6363',
                    'chart-green': '#32cd32', // Lime Green for ROI
                    'text-light': '#ffffff',
                    'text-muted': '#a0a7b4',
                },
                fontFamily: {
                    sans: ['Inter', 'sans-serif'],
                },
            }
        }
    }

    // --- Sidebar Toggling Logic for Mobile ---
    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebar-overlay');
        const isHidden = sidebar.classList.contains('-translate-x-full');

        if (isHidden) {
            sidebar.classList.remove('-translate-x-full');
            sidebar.classList.add('translate-x-0');
            overlay.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        } else {
            sidebar.classList.add('-translate-x-full');
            sidebar.classList.remove('translate-x-0');
            overlay.classList.add('hidden');
            document.body.style.overflow = 'auto';
        }
    }
    
    // --- Global Config ---
    const CHART_VIEWS = { YEAR: 'year', MONTH: 'month', WEEK: 'week', DAY: 'day' };
    const MARKET_GROUPS = ["CR AH", "CA AH", "CR O/U", "CA O/U"];
    let currentView = CHART_VIEWS.WEEK;
    let currentTab = 'stake';
    let mainChartInstance = null;
    let chartData = []; 

    // --- DOM Elements ---
    const mainTitleEl = document.getElementById('main-chart-title');
    const totalEventsCountEl = document.getElementById('total-events-count');
    const viewButtons = document.querySelectorAll('#view-selector .view-btn');
    const tabButtons = document.querySelectorAll('#main-tabs .tab-btn');
    
    // --- ALERT FUNCTION ---
    /** * Shows a popup alerting the user that the dashboard is using mock data.
      * NOTE: This uses alert(). Replace this with a proper modal/toast implementation 
      * for a better user experience.
      */
    function showMockDataAlert() {
        // Using a custom modal would be better, but keeping alert as per existing code structure
        // and explicit request not to change anything else.
        console.warn("ðŸš¨ WARNING: No data was found for this profile, or the API call failed. Displaying mock (dummy) data instead.");
        // alert("ðŸš¨ WARNING: No data was found for this profile, or the API call failed. Displaying mock (dummy) data instead.");
    }

    // --- DATA FETCHING & MOCK FALLBACK FUNCTIONS ---

    /** Generates mock daily data for a full year, including Office and Confirm versions. */
    function generateMockData() {
        const data = [];
        if (typeof moment === 'undefined') {
            console.error("Moment.js is not loaded. Cannot generate mock data.");
            return data;
        }

        const endDate = moment();
        const startDate = moment().subtract(365, 'days');
        
        let currentDay = startDate.clone();
        while (currentDay.isBefore(endDate)) {
            const dayString = currentDay.format('YYYY-MM-DD');
            const weekString = `Week ${currentDay.isoWeek()} ${currentDay.isoWeekYear()}`;

            // --- Base Metrics ---
            const baseStake = Math.floor(Math.random() * 20000 + 50000);
            const dailyPL = Math.floor(Math.random() * 2000 - 500);
            const dailyROI = (dailyPL / baseStake) * 100 * (1 + Math.random() * 0.5);

            // --- Office/Confirm Version Adjustments ---
            // PL variations
            const dailyPLOffice = dailyPL + Math.floor(Math.random() * 500 - 250); 
            const dailyPLConfirm = dailyPL + Math.floor(Math.random() * 500 - 250);
            
            // Stake variations
            const baseStakeOffice = baseStake + Math.floor(Math.random() * 10000 - 5000);
            const baseStakeConfirm = baseStake + Math.floor(Math.random() * 10000 - 5000);

            // ROI calculated based on respective PL/Stake versions
            const dailyROIOffice = (dailyPLOffice / baseStakeOffice) * 100 * (1 + Math.random() * 0.5);
            const dailyROIConfirm = (dailyPLConfirm / baseStakeConfirm) * 100 * (1 + Math.random() * 0.5);

            data.push({
                _id: dayString,
                date: dayString,
                // Stake Versions
                stake: baseStake,
                stakeOffice: baseStakeOffice, 
                stakeConfirm: baseStakeConfirm, 
                // PL Versions
                pl: dailyPL,
                plOffice: dailyPLOffice, 
                plConfirm: dailyPLConfirm, 
                // ROI Versions
                roi: Math.max(-5, parseFloat(dailyROI.toFixed(2))),
                roiOffice: Math.max(-5, parseFloat(dailyROIOffice.toFixed(2))), 
                roiConfirm: Math.max(-5, parseFloat(dailyROIConfirm.toFixed(2))), 
                events: Math.floor(Math.random() * 15 + 5),
                week: weekString
            });
            currentDay.add(1, 'day');
        }
        return data;
    }

    /**
     * Fetches real daily analytics data from the API endpoint.
     * Returns the data, or null if mock data was generated due to error/empty response.
     * @param {string} profileId - The profile identifier from the URL parameter.
     */
    async function fetchDailyAnalytics(profileId) {
        
        const encodedProfileId = encodeURIComponent(profileId);
        const apiEndpoint = `https://eagle-current-dinosaur.ngrok-free.app/daily-stats?client1=${encodedProfileId}`; 

        const requestOptions = {
            method: "GET",
            headers: {
                "ngrok-skip-browser-warning": "true",
                "Accept": "application/json" 
            }
        };
        
        let data = [];
        let isMock = false;

        try {
            console.log(`Attempting to fetch data from: ${apiEndpoint}`);
            
            const response = await fetch(apiEndpoint, requestOptions);
            
            if (!response.ok) {
                // If HTTP status is not 2xx, throw error to catch block
                throw new Error(`HTTP error! Status: ${response.status}`);
            }

            data = await response.json();
            
            // --- NEW: Check for empty array ---
            if (!data || data.length === 0) {
                console.warn("API returned an empty data set. Generating mock data.");
                data = generateMockData();
                isMock = true;
            } else {
                console.log("Data successfully loaded from API.");
            }
            // --- END NEW CHECK ---
            
        } catch (error) {
            console.error("Critical Fetch Error:", error.message);
            console.warn("Falling back to mock data due to API error.");
            data = generateMockData();
            isMock = true;
        }

        // Return the data object along with the mock flag
        return { data: data, isMock: isMock };
    }


    /** Generates mock data for market group comparison charts. */
    function generateMarketData() {
        const stakeData = {};
        const roiData = {};
        
        MARKET_GROUPS.forEach(market => {
            stakeData[market] = Math.floor(Math.random() * 30000 + 5000);
            roiData[market] = parseFloat((Math.random() * 20 - 5).toFixed(1)); 
        });

        return { stakeData, roiData };
    }

    /** Aggregates the main chart data based on the selected view. */
    function aggregateData(view, metric) {
        let labels = [];
        let dataRegular = []; // Stores the 'metric' data
        let dataOffice = []; // Stores the 'metricOffice' data
        let dataConfirm = []; // Stores the 'metricConfirm' data

        let unit = (metric === 'roi') ? '%' : (metric === 'pl' ? 'â‚¬' : '$'); 

        // Define the three metric keys
        const metricOffice = metric + 'Office';
        const metricConfirm = metric + 'Confirm';

        if (view === CHART_VIEWS.WEEK) {
            const weeklyAggregated = {};

            chartData.forEach(item => {
                const key = item.week; 
                if (!key) return; 

                // Initialize aggregation structure for all three versions
                weeklyAggregated[key] = (weeklyAggregated[key] || { 
                    sum: 0, count: 0, 
                    sumOffice: 0, countOffice: 0, 
                    sumConfirm: 0, countConfirm: 0 
                });

                if (metric === 'roi') {
                    // ROI requires averaging (sum and count)
                    weeklyAggregated[key].sum += item[metric];
                    weeklyAggregated[key].count += 1;
                    weeklyAggregated[key].sumOffice += item[metricOffice];
                    weeklyAggregated[key].countOffice += 1;
                    weeklyAggregated[key].sumConfirm += item[metricConfirm];
                    weeklyAggregated[key].countConfirm += 1;
                } else { 
                    // PL/Stake require simple summation
                    weeklyAggregated[key].sum += item[metric];
                    weeklyAggregated[key].sumOffice += item[metricOffice];
                    weeklyAggregated[key].sumConfirm += item[metricConfirm];
                }
            });

            const orderedKeys = Object.keys(weeklyAggregated).sort((a, b) => {
                const yearA = parseInt(a.substring(a.length - 4));
                const weekA = parseInt(a.substring(5, a.indexOf(' ', 5)));
                
                const yearB = parseInt(b.substring(b.length - 4));
                const weekB = parseInt(b.substring(5, b.indexOf(' ', 5)));
                
                if (yearA !== yearB) return yearA - yearB;
                return weekA - weekB;
            });
            
            // Map Regular data
            dataRegular = orderedKeys.map(key => {
                const item = weeklyAggregated[key];
                if (metric === 'roi') {
                    return parseFloat((item.sum / item.count).toFixed(2));
                }
                return item.sum;
            });
            
            // Map Office data
            dataOffice = orderedKeys.map(key => {
                const item = weeklyAggregated[key];
                if (metric === 'roi') {
                    return parseFloat((item.sumOffice / item.countOffice).toFixed(2));
                }
                return item.sumOffice;
            });

            // Map Confirm data
            dataConfirm = orderedKeys.map(key => {
                const item = weeklyAggregated[key];
                if (metric === 'roi') {
                    return parseFloat((item.sumConfirm / item.countConfirm).toFixed(2));
                }
                return item.sumConfirm;
            });
            
            labels = orderedKeys.map(key => {
                 const weekNum = key.substring(5, key.indexOf(' ', 5));
                 return `Wk ${weekNum}`;
            });
        
        } else {
            
            const aggregated = {};

            const filterAndGroup = (item, date) => {
                let key = '';
                switch (view) {
                    case CHART_VIEWS.YEAR:
                        key = date.format('YYYY-MM');
                        break;
                    case CHART_VIEWS.MONTH:
                        if (moment().diff(date, 'days') <= 30) {
                            key = date.format('MM/DD');
                        }
                        break;
                }
                return key;
            };

            chartData.forEach(item => {
                const date = moment(item.date);
                const key = filterAndGroup(item, date);

                if (key) {
                    if (metric === 'roi') {
                        // Initialize and aggregate ROI (Average)
                        aggregated[key] = (aggregated[key] || { 
                            sum: 0, count: 0, 
                            sumOffice: 0, countOffice: 0, 
                            sumConfirm: 0, countConfirm: 0 
                        });
                        aggregated[key].sum += item[metric];
                        aggregated[key].count += 1;
                        aggregated[key].sumOffice += item[metricOffice];
                        aggregated[key].countOffice += 1;
                        aggregated[key].sumConfirm += item[metricConfirm];
                        aggregated[key].countConfirm += 1;
                    } else {
                        // Initialize and aggregate PL/Stake (Sum)
                        aggregated[key] = (aggregated[key] || { sum: 0, sumOffice: 0, sumConfirm: 0 });
                        aggregated[key].sum += item[metric];
                        aggregated[key].sumOffice += item[metricOffice];
                        aggregated[key].sumConfirm += item[metricConfirm];
                    }
                }
            });

            labels = Object.keys(aggregated).sort();
            
            // Map Regular data
            dataRegular = labels.map(key => {
                if (metric === 'roi') {
                    const avg = aggregated[key].sum / aggregated[key].count;
                    return parseFloat(avg.toFixed(2));
                }
                return aggregated[key].sum;
            });

            // Map Office data
            dataOffice = labels.map(key => {
                if (metric === 'roi') {
                    const avg = aggregated[key].sumOffice / aggregated[key].countOffice;
                    return parseFloat(avg.toFixed(2));
                }
                return aggregated[key].sumOffice;
            });

            // Map Confirm data
            dataConfirm = labels.map(key => {
                if (metric === 'roi') {
                    const avg = aggregated[key].sumConfirm / aggregated[key].countConfirm;
                    return parseFloat(avg.toFixed(2));
                }
                return aggregated[key].sumConfirm;
            });

            if (view === CHART_VIEWS.YEAR) {
                labels = labels.map(key => moment(key, 'YYYY-MM').format('MMM'));
            }
        }
        
        return { labels, dataRegular, dataOffice, dataConfirm, unit };
    }

    // --- Chart Configuration Templates ---
    /**
     * Re-uses the original configuration function, but checks if the 'data' argument 
     * is actually an array of dataset objects (used by renderMainChart for 3 lines) 
     * or a simple data array (used by other charts for 1 line).
     */
    function getChartConfig(type, labels, dataOrDatasets, metric, unit, colorKey) {
        const isLine = type === 'line';
        const accentColor = tailwind.config.theme.extend.colors[colorKey] || tailwind.config.theme.extend.colors['accent-1'];

        let datasets = [];
        let displayLegend = false;

        // Check if the input is an array of datasets (used for 3 lines)
        if (Array.isArray(dataOrDatasets) && dataOrDatasets.length > 0 && typeof dataOrDatasets[0] === 'object' && 'label' in dataOrDatasets[0]) {
            datasets = dataOrDatasets;
            displayLegend = true; // Show legend for multi-line charts
        } else {
            // Fallback to original single dataset creation (used for Events and Market charts)
            let backgroundColor;
            let borderWidth;
            let pointRadius = 0;

            if (isLine) {
                backgroundColor = accentColor + '40';
                borderWidth = 3;
                pointRadius = 5;
            } else {
                backgroundColor = 'transparent';
                borderWidth = 2; 
            }

            datasets = [{
                label: metric.toUpperCase(),
                data: dataOrDatasets,
                borderColor: accentColor,
                backgroundColor: backgroundColor,
                borderWidth: borderWidth,
                pointRadius: pointRadius,
                pointBackgroundColor: accentColor,
                tension: 0.4,
                fill: isLine ? 'origin' : false,
                borderRadius: 4
            }];
        }

        return {
            type: type,
            data: {
                labels: labels,
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { 
                        display: displayLegend,
                        labels: {
                            color: tailwind.config.theme.extend.colors['text-light'],
                            font: {
                                size: 14
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: (c) => {
                                const value = c.parsed.y;
                                const label = c.dataset.label; 
                                // Use the base metric passed to the function for formatting logic
                                const baseMetric = metric; 
                                
                                if (baseMetric === 'roi') return `${label}: ${value.toFixed(2)}%`;
                                if (baseMetric === 'pl') return `${label}: â‚¬ ${value.toLocaleString()}`;
                                return `${label}: $ ${value.toLocaleString()}`;
                            }
                        },
                        backgroundColor: tailwind.config.theme.extend.colors['surface'],
                        titleFont: { size: 14, weight: 'bold' },
                        bodyFont: { size: 14 },
                        padding: 10,
                        cornerRadius: 6,
                        borderWidth: 1,
                        borderColor: tailwind.config.theme.extend.colors['accent-1'] + '40'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { color: tailwind.config.theme.extend.colors['text-muted'] + '20' },
                        ticks: {
                            color: tailwind.config.theme.extend.colors['text-light'],
                            callback: (value) => {
                                let prefix = '';
                                if (unit === '$') prefix = '$';
                                else if (unit === 'â‚¬') prefix = 'â‚¬';
                                
                                if (value > 10000 || value < -10000) {
                                    return `${prefix}${(value / 1000).toFixed(0)}K`;
                                }
                                return `${prefix}${value}${unit === '%' ? '%' : ''}`;
                            },
                        },
                    },
                    x: {
                        grid: { display: false },
                        ticks: { color: tailwind.config.theme.extend.colors['text-muted'] },
                    }
                }
            }
        };
    }

    // --- Chart Rendering Functions ---

    function renderMainChart() {
        const canvas = document.getElementById('mainChart');
        if (!canvas) return;
        
        // Destructure all three data versions
        const { labels, dataRegular, dataOffice, dataConfirm, unit } = aggregateData(currentView, currentTab);
        
        // Define distinct neon colors as requested
        const NEON_PINK = '#FF6EC7'; // Regular
        const NEON_CYAN = '#00FFFF'; // Office
        const NEON_LIME = '#CCFF00'; // Confirm
        
        mainTitleEl.textContent = currentTab.toUpperCase();

        // Construct the three datasets with distinct styling
        const datasets = [
            // Dataset 1: Regular (Base Metric) - Solid Line, Neon Pink, Filled Area
            {
                label: `${currentTab.toUpperCase()} (Regular)`,
                data: dataRegular,
                borderColor: NEON_PINK,
                backgroundColor: NEON_PINK + '40', // Semi-transparent fill
                borderWidth: 3,
                pointRadius: 5,
                pointBackgroundColor: NEON_PINK,
                tension: 0.4,
                fill: 'origin',
                borderRadius: 4,
                borderDash: [] // Ensure solid line
            },
            // Dataset 2: Office - Neon Cyan, Solid Line, No Fill
            {
                label: `${currentTab.toUpperCase()} (Office)`,
                data: dataOffice,
                borderColor: NEON_CYAN, 
                backgroundColor: 'transparent',
                borderWidth: 3, 
                pointRadius: 3, 
                pointBackgroundColor: NEON_CYAN,
                tension: 0.4,
                fill: false,
                borderDash: [] // Ensure solid line
            },
            // Dataset 3: Confirm - Neon Lime, Solid Line, No Fill
            {
                label: `${currentTab.toUpperCase()} (Confirm)`,
                data: dataConfirm,
                borderColor: NEON_LIME, 
                backgroundColor: 'transparent',
                borderWidth: 3, 
                pointRadius: 2, 
                pointBackgroundColor: NEON_LIME,
                tension: 0.4,
                fill: false,
                borderDash: [] // Ensure solid line
            }
        ];

        // Recalculate colorKey just for the function call argument, matching original flow
        const colorKey = currentTab === 'pl' ? 'accent-2' : (currentTab === 'roi' ? 'chart-green' : 'accent-1');

        // Pass the array of datasets to getChartConfig
        const config = getChartConfig('line', labels, datasets, currentTab, unit, colorKey);
        
        // Configure Y-axis for zero
        config.options.scales.y.beginAtZero = (currentTab === 'roi' || currentTab === 'pl'); 

        if (mainChartInstance) {
            mainChartInstance.data = config.data;
            mainChartInstance.options = config.options;
            mainChartInstance.update();
        } else {
            mainChartInstance = new Chart(canvas.getContext('2d'), config);
        }
    }

   function renderEventsChart() {
    if (!chartData || chartData.length === 0) return;
    // const latestData = chartData.slice(-56);
    const latestData = chartData;
    
    const weeklyEvents = {};
    const weeklyEventsDetails = {};
    latestData.forEach(item => {
        const weekKey = item.week; 
        if (!weekKey) return; 
        weeklyEvents[weekKey] = (weeklyEvents[weekKey] || 0) + item.events;
        
        // Use a safe check for eventTags
        if (item.eventTags && Array.isArray(item.eventTags)) {
             item.eventTags.forEach(eventTag => {
                let parts = eventTag.split("__");
                if (parts.length < 5) return; // Safety check for tag structure
                
                let eventHome = parts[0];
                let eventAway = parts[1];
                let eventDate = parts[3];
                let eventLine = parts[4];
                
                let eventAssembled = `${eventDate} | ${eventHome} vs ${eventAway} : ${eventLine}`;
                
                if (!weeklyEventsDetails[weekKey]) {
                    weeklyEventsDetails[weekKey] = [];
                }
                weeklyEventsDetails[weekKey].push(eventAssembled);
            });
        }
    });
    
    const orderedKeys = Object.keys(weeklyEvents).sort((a, b) => {
        const yearA = parseInt(a.substring(a.length - 4));
        const weekA = parseInt(a.substring(5, a.indexOf(' ', 5)));
        
        const yearB = parseInt(b.substring(b.length - 4));
        const weekB = parseInt(b.substring(5, b.indexOf(' ', 5)));
        
        if (yearA !== yearB) return yearA - yearB;
        return weekA - weekB;
    });

    const orderedData = orderedKeys.map(k => weeklyEvents[k]);
    const labels = orderedKeys.map(key => {
         const weekNum = key.substring(5, key.indexOf(' ', 5));
         return `Wk ${weekNum}`;
    });

    // --- START: MODAL GENERATION AND MANAGEMENT (Self-Contained) ---
    
    const MODAL_ID = 'events-chart-modal';
    
    // Define the close function and expose it globally for the dynamically generated button's `onclick`
    const closeModal = () => {
        const container = document.getElementById(MODAL_ID);
        const content = document.getElementById('events-chart-modal-content');
        if (container && content) {
            container.classList.add('hidden');
            container.classList.remove('flex');
            // Animate out
            content.classList.remove('scale-100', 'opacity-100');
            content.classList.add('scale-95', 'opacity-0');
            document.body.style.overflow = 'auto';
        }
    };
    window.closeEventsChartModal = closeModal; 

    // Create modal element if it doesn't exist
    let modalContainer = document.getElementById(MODAL_ID);
    if (!modalContainer) {
        modalContainer = document.createElement('div');
        modalContainer.id = MODAL_ID;
        // Tailwind classes for fixed, full screen, dark backdrop, initially hidden
        modalContainer.className = 'fixed inset-0 z-50 bg-black/80 hidden items-center justify-center p-4 transition-all duration-300'; 
        
        // Inner HTML structure using Tailwind classes
        modalContainer.innerHTML = `
            <div id="events-chart-modal-content" class="relative w-full max-w-lg bg-surface rounded-xl shadow-2xl overflow-hidden border border-accent-1/50 transform transition-all duration-300 scale-95 opacity-0">
                <!-- Header -->
                <div class="flex justify-between items-center p-4 md:p-6 bg-surface/80 border-b border-accent-1/50">
                    <h3 id="modal-week-title" class="text-xl font-bold text-accent-1">Event Details</h3>
                    <button onclick="window.closeEventsChartModal()" class="text-text-muted hover:text-white transition duration-200">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                
                <!-- Body -->
                <div class="p-4 md:p-6 max-h-[70vh] overflow-y-auto">
                    <ul id="modal-content-list" class="space-y-2">
                        <!-- Content populated by showModal -->
                    </ul>
                </div>

                <!-- Footer -->
                <div class="p-4 md:p-6 border-t border-accent-1/50">
                    <button onclick="window.closeEventsChartModal()" class="w-full px-4 py-2 bg-accent-1/80 hover:bg-accent-1 text-white font-semibold rounded-lg transition duration-200 shadow-md shadow-accent-1/30">
                        Close
                    </button>
                </div>
            </div>
        `;
        document.body.appendChild(modalContainer);

        // Close on backdrop click (only if the click target is the container itself)
        modalContainer.onclick = (e) => {
            if (e.target === modalContainer) {
                closeModal();
            }
        };
    }

    // Define the show function (local to the chart renderer)
    const showModal = (weekKey, details) => {
        const titleEl = document.getElementById('modal-week-title');
        const listEl = document.getElementById('modal-content-list');
        const container = document.getElementById(MODAL_ID);
        const content = document.getElementById('events-chart-modal-content');

        if (!titleEl || !listEl || !container || !content) return;

        titleEl.textContent = `Events for ${weekKey}`;
        listEl.innerHTML = ''; // Clear previous content

        if (details && details.length > 0) {
            details.forEach(detail => {
                const li = document.createElement('li');
                // Styling for list item
                li.className = 'py-2 px-3 bg-surface/50 text-sm text-text-light rounded-md border border-accent-1/20 break-words';
                li.textContent = detail;
                listEl.appendChild(li);
            });
        } else {
            listEl.innerHTML = '<li class="p-2 text-sm text-text-muted">No specific event details found for this week.</li>';
        }

        container.classList.remove('hidden');
        container.classList.add('flex'); // Show backdrop
        document.body.style.overflow = 'hidden';
        
        // Animate in
        setTimeout(() => {
            content.classList.remove('scale-95', 'opacity-0');
            content.classList.add('scale-100', 'opacity-100');
        }, 10);
    };
    
    // --- END: MODAL GENERATION AND MANAGEMENT ---

    const config = getChartConfig('line', labels, orderedData, 'Events', ' Events', 'accent-1');
    config.options.elements = { line: { tension: 0.2 }, point: { radius: 3 } };
    // console.log(weeklyEventsDetails); // Keep your original console log

    // --- ADD CLICK HANDLER TO CHART OPTIONS ---
    config.options.onClick = (e) => {
        // Use Chart.getChart to ensure we use the correct instance if it was destroyed/re-created
        let eventsChartInstance = Chart.getChart('eventsPerWeekChart');
        if (!eventsChartInstance) return;

        const points = eventsChartInstance.getElementsAtEventForMode(e, 'nearest', { intersect: true }, true);

        if (points.length) {
            const firstPoint = points[0];
            const index = firstPoint.index;
            const weekKey = orderedKeys[index]; // Get the week key from the ordered list
            
            showModal(weekKey, weeklyEventsDetails[weekKey] || []);
        }
    };
    // ------------------------------------------

    // Handle existing chart instance cleanup if needed (assuming `eventsChartInstance` is global)
    let eventsChartInstance = Chart.getChart('eventsPerWeekChart');
    if (eventsChartInstance) {
        eventsChartInstance.destroy();
    }
    
    new Chart(document.getElementById('eventsPerWeekChart').getContext('2d'), config);
}

    function renderMarketCharts() {
        const { stakeData, roiData } = generateMarketData();

        const stakeLabels = MARKET_GROUPS;
        const stakeValues = MARKET_GROUPS.map(m => stakeData[m]);
        const stakeConfig = getChartConfig('bar', stakeLabels, stakeValues, 'Stake', '$', 'accent-2');
        stakeConfig.options.scales.x.ticks.callback = (val) => stakeLabels[val]; 
        new Chart(document.getElementById('stakePerMarketChart').getContext('2d'), stakeConfig);

        const roiLabels = MARKET_GROUPS;
        const roiValues = MARKET_GROUPS.map(m => roiData[m]);
        const roiConfig = getChartConfig('bar', roiLabels, roiValues, 'ROI', '%', 'chart-green');
        roiConfig.options.scales.x.ticks.callback = (val) => roiLabels[val]; 
        roiConfig.options.scales.y.beginAtZero = false;
        
        new Chart(document.getElementById('roiPerMarketChart').getContext('2d'), roiConfig);
    }

    // --- Interaction Handlers (omitted for brevity) ---

    function switchView(view) {
        currentView = view;
        
        viewButtons.forEach(btn => {
            const isActive = btn.dataset.view === view;
            btn.classList.toggle('bg-surface/50', isActive);
            btn.classList.toggle('text-white', isActive);
            btn.classList.toggle('hover:bg-surface/50', !isActive);
            btn.classList.toggle('text-text-muted', !isActive);
        });

        renderMainChart();
    }

    function switchTab(tab) {
        currentTab = tab;

        tabButtons.forEach(btn => {
            const isActive = btn.dataset.tab === tab;
            
            const isStake = tab === 'stake';
            const isPL = tab === 'pl';
            const isROI = tab === 'roi';

            btn.classList.toggle('bg-accent-1', isStake && isActive);
            btn.classList.toggle('bg-accent-2', isPL && isActive);
            btn.classList.toggle('bg-chart-green', isROI && isActive);
            
            btn.classList.toggle('text-white', isActive);
            btn.classList.toggle('shadow-lg', isActive);
            
            btn.classList.toggle('bg-transparent', !isActive);
            btn.classList.toggle('hover:text-white', !isActive);
            btn.classList.toggle('text-text-muted', !isActive);
            btn.classList.toggle('shadow-none', !isActive);
        });

        renderMainChart();
    }


        // Add this line globally to store the profile once it's read
        window.currentProfile = "User"; // Default fallback

        // Function to update the HREFs of all sidebar links
        function updateSidebarLinks(profile) {
            if (!profile) return; // Stop if no profile is found

            // Find all anchor tags within the sidebar nav
            const links = document.querySelectorAll('#sidebar nav a');

            links.forEach(link => {
                let originalHref = link.getAttribute('href');

                // Check if the href is a local file (e.g., dashboard.html) and not a full URL or '#'
                if (originalHref && originalHref.endsWith('.html')) {
                    // Remove any existing query string before adding the new one
                    const cleanHref = originalHref.split('?')[0];
                    
                    // Reconstruct the URL with the encoded profile
                    link.setAttribute('href', `${cleanHref}?profile=${encodeURIComponent(profile)}`);
                } 
                
                // Handle the active Market Stats link separately, if needed, 
                // to ensure it loads with the profile context if the user refreshes.
                if (link.dataset.page === 'market-stats') {
                    // For the currently active page, we can also ensure the URL has the profile
                    link.setAttribute('href', `m-stats.html?profile=${encodeURIComponent(profile)}`);
                }
            });
        }


    /** Application startup function. */
    async function initializeApp() {
        lucide.createIcons();
        const params = new URLSearchParams(window.location.search);
        const profile = params.get("profile") || "User";

        // Placeholder for missing DOM element, assuming it exists in the main HTML
        const profileTitleEl = document.getElementById("profileTitle");
        if (profileTitleEl) {
            profileTitleEl.innerText = profile + " Analytics & Stats";
        } else {
            console.warn("Profile title element not found, skipping title update.");
        }


        // Mock initialization for Firebase since it's used in original script but missing definition
        window.initFirebase = window.initFirebase || (() => Promise.resolve());
        await window.initFirebase();

        updateSidebarLinks(profile);

        // 2. Load Data and check if it's mock data
        const result = await fetchDailyAnalytics(profile);
        chartData = result.data;
        
        // --- NEW: Display alert if mock data was generated ---
        if (result.isMock) {
            showMockDataAlert();
        }
        // --- END NEW CHECK ---

        const totalEvents = chartData.reduce((sum, item) => sum + item.events, 0);
        if(totalEventsCountEl) {
           totalEventsCountEl.textContent = totalEvents.toLocaleString();
        }


        // 3. Set up Event Listeners
        const menuToggle = document.getElementById('menu-toggle');
        if (menuToggle) {
            menuToggle.addEventListener('click', toggleSidebar);
        }
        
        document.querySelectorAll('.sidebar-link').forEach(link => {
            link.addEventListener('click', () => {
                if (window.innerWidth < 768) {
                    toggleSidebar();
                }
            });
        });

        viewButtons.forEach(button => {
            button.addEventListener('click', () => {
                switchView(button.dataset.view);
            });
        });

        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                switchTab(button.dataset.tab);
            });
        });

        // 4. Initial Render
        switchView(currentView); 
        switchTab(currentTab); 

        // Check if chart canvases exist before rendering non-main charts
        if (document.getElementById('eventsPerWeekChart')) renderEventsChart();
        if (document.getElementById('stakePerMarketChart') && document.getElementById('roiPerMarketChart')) renderMarketCharts();
    }

    // Initialize the app when the DOM is ready
    document.addEventListener('DOMContentLoaded', initializeApp);
</script>
<!-- 
    NOTE: The HTML structure for the dashboard (sidebar, menu-toggle, main-chart-title, 
    view-selector, main-tabs, chart canvases, etc.) is assumed to exist outside this 
    script block for the functions to fully operate.
-->
</body>

</html>