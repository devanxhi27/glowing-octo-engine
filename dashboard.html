<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- Load Moment.js for date handling -->
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
    <!-- Load Lucide icons (open-source vector icons) -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'background': '#0d0d21',   // Very deep, dark blue/black
                        'surface': '#1a1a36',      // Darker card background
                        'accent-1': '#00ffff',     // NEON CYAN/BLUE (Primary accent)
                        'accent-2': '#ff00aa',     // NEON PINK/MAGENTA (Secondary/Alert accent)
                        'sidebar-start': '#0d0d21',// Matches background for smooth sidebar start
                        'sidebar-end': '#4d0099',  // Deep Violet/Purple for gradient end
                        'text-light': '#f0f8ff',   // Crisp white/azure
                        'text-muted': '#8b8c9d',   // Muted gray for secondary text
                        'chart-green': '#39ff14',  // NEON LIME GREEN (Success/ROI)
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Custom scrollbar for dark theme */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1e274a;
        }

        ::-webkit-scrollbar-thumb {
            background: #4c1d95;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #3b82f6;
        }

        #sidebar {
            height: auto;
        }
    </style>
    <!-- Firebase/Firestore boilerplate -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        window.db = null;
        window.auth = null;

        async function initFirebase() {
            if (!firebaseConfig) {
                console.warn("Firebase config not found. Running in mock data mode.");
                return;
            }
            try {
                setLogLevel('error');
                const app = initializeApp(firebaseConfig);
                window.db = getFirestore(app);
                window.auth = getAuth(app);

                if (initialAuthToken) {
                    await signInWithCustomToken(window.auth, initialAuthToken);
                } else {
                    await signInAnonymously(window.auth);
                }
                // console.log("Firebase initialized and authenticated.");
            } catch (error) {
                console.error("Firebase initialization or sign-in failed:", error);
            }
        }
        window.initFirebase = initFirebase;
    </script>
</head>

<body class="bg-background text-text-light flex min-h-screen relative">

    <!-- Mobile Sidebar Overlay (Visible only on small screens when menu is open) -->
    <div id="sidebar-overlay"
        class="fixed inset-0 bg-background bg-opacity-70 z-40 hidden md:hidden transition-opacity duration-300"
        onclick="toggleSidebar()"></div>

    <!-- Sidebar (Now uses fixed positioning for mobile off-canvas behavior) -->
    <div id="sidebar" class="fixed inset-y-0 left-0 z-50 w-64 bg-sidebar-start bg-gradient-to-br from-sidebar-start to-sidebar-end text-white shadow-2xl p-4 
        transform -translate-x-full md:translate-x-0 transition-transform duration-300 
        md:static md:flex md:flex-col md:h-screen">

        <a href="clients.html">
            <div class="flex items-center space-x-3 mb-8 p-2">
                <div class="p-2 rounded-full bg-white bg-opacity-20">
                    <i data-lucide="zap" class="w-6 h-6 text-accent-1"></i>
                </div>
                <h2 class="text-xl font-bold tracking-wider">DASHBOARD</h2>
            </div>
        </a>

        <nav class="space-y-2 flex-grow">
            <!-- Navigation Links -->
            <a href="#"
                class="sidebar-link flex items-center space-x-3 p-3 rounded-xl bg-white bg-opacity-10 font-semibold transition duration-200 hover:bg-opacity-20">
                <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                <span>Dashboard</span>
            </a>
            <a href="#"
                class="sidebar-link flex items-center space-x-3 p-3 rounded-xl transition duration-200 hover:bg-white hover:bg-opacity-10">
                <i data-lucide="calendar" class="w-5 h-5"></i>
                <span>Monthly Stats</span>
            </a>
            <a href="#"
                class="sidebar-link flex items-center space-x-3 p-3 rounded-xl transition duration-200 hover:bg-white hover:bg-opacity-10">
                <i data-lucide="trophy" class="w-5 h-5"></i>
                <span>League Stats</span>
            </a>
            <a href="#"
                class="sidebar-link flex items-center space-x-3 p-3 rounded-xl transition duration-200 hover:bg-white hover:bg-opacity-10">
                <i data-lucide="trending-up" class="w-5 h-5"></i>
                <span>Market Stats</span>
            </a>
            <a href="#"
                class="sidebar-link flex items-center space-x-3 p-3 rounded-xl transition duration-200 hover:bg-white hover:bg-opacity-10">
                <i data-lucide="banknote" class="w-5 h-5"></i>
                <span>Bookmaker Stats</span>
            </a>
            <a href="#"
                class="sidebar-link flex items-center space-x-3 p-3 rounded-xl transition duration-200 hover:bg-white hover:bg-opacity-10">
                <i data-lucide="calendar-check" class="w-5 h-5"></i>
                <span>Event Stats</span>
            </a>
            <a href="#"
                class="sidebar-link flex items-center space-x-3 p-3 rounded-xl transition duration-200 hover:bg-white hover:bg-opacity-10">
                <i data-lucide="sigma" class="w-5 h-5"></i>
                <span>Complex Analysis</span>
            </a>
        </nav>

        <div class="mt-auto pt-4 border-t border-white border-opacity-10">
            <a href="#"
                class="flex items-center justify-center p-3 rounded-xl text-xs font-bold uppercase tracking-wider text-text-light bg-accent-2 hover:bg-accent-1/90 transition duration-200">
                <i data-lucide="rocket" class="w-4 h-4 mr-2"></i>
                CREATE PDF
            </a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="flex-1 p-4 md:p-8 overflow-auto">
        <!-- Top Header & Controls -->
        <header class="flex justify-between items-center mb-6">
            <!-- Mobile Menu Toggle Button (Hamburger) -->
            <button id="menu-toggle" class="md:hidden text-text-light hover:text-accent-1 transition mr-4">
                <i data-lucide="menu" class="w-7 h-7"></i>
            </button>

            <h3 id="profileTitle" class="text-xl sm:text-2xl font-bold tracking-wider text-white flex-1">DASHBOARD</h3>

            <div class="flex items-center space-x-4">
                <button class="text-text-muted hover:text-white transition"><i data-lucide="search"
                        class="w-5 h-5"></i></button>
                <button class="text-text-muted hover:text-white transition"><i data-lucide="settings"
                        class="w-5 h-5"></i></button>
                <div class="w-8 h-8 rounded-full bg-gray-500"></div>
            </div>
        </header>

        <!-- Main Chart Section (STAKE/PL/ROI) -->
        <div class="bg-surface rounded-xl shadow-2xl p-4 md:p-6 mb-8 border border-surface/50">

            <div
                class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 border-b border-white border-opacity-10 pb-4">
                <div class="flex flex-wrap items-center space-x-2 mb-3 sm:mb-0">
                    <h2 class="text-xl font-bold text-text-light" id="main-chart-title">STAKE</h2>
                    <!-- Tab Switcher -->
                    <div id="main-tabs"
                        class="inline-flex rounded-full bg-background p-1 text-sm text-text-muted mt-2 sm:mt-0">
                        <button data-tab="stake"
                            class="tab-btn px-4 py-1 rounded-full font-semibold transition-colors duration-200 bg-accent-1 text-white shadow-lg">Stake</button>
                        <button data-tab="pl"
                            class="tab-btn px-4 py-1 rounded-full font-semibold transition-colors duration-200 hover:text-white">PL</button>
                        <button data-tab="roi"
                            class="tab-btn px-4 py-1 rounded-full font-semibold transition-colors duration-200 hover:text-white">ROI</button>
                    </div>
                </div>

                <!-- Time View Selector -->
                <div id="view-selector" class="inline-flex rounded-full bg-background p-1 text-xs text-text-muted">
                    <button data-view="year"
                        class="view-btn px-3 py-1 rounded-full font-semibold transition-colors duration-200 bg-surface/50 text-white">Year</button>
                    <button data-view="month"
                        class="view-btn px-3 py-1 rounded-full font-semibold transition-colors duration-200 hover:bg-surface/50 hover:text-white">Month</button>
                    <button data-view="week"
                        class="view-btn px-3 py-1 rounded-full font-semibold transition-colors duration-200 hover:bg-surface/50 hover:text-white">Week</button>
                    <!-- <button data-view="day" class="view-btn px-3 py-1 rounded-full font-semibold transition-colors duration-200 hover:bg-surface/50 hover:text-white">Day</button> -->
                </div>
            </div>

            <div class="relative h-72 lg:h-96">
                <canvas id="mainChart"></canvas>
            </div>
        </div>

        <!-- Three Small Charts Section (Responsive Grid) -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">

            <!-- Chart 1: Events per Week (Line Chart) -->
            <div class="bg-surface rounded-xl p-4 shadow-xl border border-surface/50">
                <div class="flex items-center space-x-3 mb-3">
                    <div class="p-2 rounded-full bg-accent-1/20 text-accent-1">
                        <i data-lucide="calendar-heart" class="w-5 h-5"></i>
                    </div>
                    <h3 class="text-text-muted text-sm font-semibold">Total Events Tracked</h3>
                </div>
                <p class="text-2xl font-extrabold text-white mb-2" id="total-events-count">...</p>
                <div class="relative h-32">
                    <canvas id="eventsPerWeekChart"></canvas>
                </div>
            </div>

            <!-- Chart 2: Total Stake per Market Group (Bar Chart) -->
            <div class="bg-surface rounded-xl p-4 shadow-xl border border-surface/50">
                <div class="flex items-center space-x-3 mb-3">
                    <div class="p-2 rounded-full bg-accent-2/20 text-accent-2">
                        <i data-lucide="banknote" class="w-5 h-5"></i>
                    </div>
                    <h3 class="text-text-muted text-sm font-semibold">Stake per Market Group</h3>
                </div>
                <p class="text-2xl font-extrabold text-white mb-2">$ 8,500 <span
                        class="text-text-muted text-sm font-normal"> (Weekly Avg)</span></p>
                <div class="relative h-32">
                    <canvas id="stakePerMarketChart"></canvas>
                </div>
            </div>

            <!-- Chart 3: Total ROI per Market Group (Bar Chart) -->
            <div class="bg-surface rounded-xl p-4 shadow-xl border border-surface/50 lg:col-span-1 md:col-span-2">
                <div class="flex items-center space-x-3 mb-3">
                    <div class="p-2 rounded-full bg-chart-green/20 text-chart-green">
                        <i data-lucide="percent" class="w-5 h-5"></i>
                    </div>
                    <h3 class="text-text-muted text-sm font-semibold">ROI per Market Group</h3>
                </div>
                <p class="text-2xl font-extrabold text-white mb-2">15.2% <span
                        class="text-text-muted text-sm font-normal"> (Avg ROI)</span></p>
                <div class="relative h-32">
                    <canvas id="roiPerMarketChart"></canvas>
                </div>
            </div>
        </div>

    </div>

    <!-- Chart and Interaction Logic -->
   <script>
    // --- Sidebar Toggling Logic for Mobile ---
    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebar-overlay');
        const isHidden = sidebar.classList.contains('-translate-x-full');

        if (isHidden) {
            sidebar.classList.remove('-translate-x-full');
            sidebar.classList.add('translate-x-0');
            overlay.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        } else {
            sidebar.classList.add('-translate-x-full');
            sidebar.classList.remove('translate-x-0');
            overlay.classList.add('hidden');
            document.body.style.overflow = 'auto';
        }
    }
    
    // --- Global Config ---
    const CHART_VIEWS = { YEAR: 'year', MONTH: 'month', WEEK: 'week', DAY: 'day' };
    const MARKET_GROUPS = ["CR AH", "CA AH", "CR O/U", "CA O/U"];
    let currentView = CHART_VIEWS.YEAR;
    let currentTab = 'stake';
    let mainChartInstance = null;
    let chartData = []; 

    // --- DOM Elements ---
    const mainTitleEl = document.getElementById('main-chart-title');
    const totalEventsCountEl = document.getElementById('total-events-count');
    const viewButtons = document.querySelectorAll('#view-selector .view-btn');
    const tabButtons = document.querySelectorAll('#main-tabs .tab-btn');

    // --- DATA FETCHING & MOCK FALLBACK FUNCTIONS ---

    /** Generates mock daily data for a full year. */
    function generateMockData() {
        const data = [];
        if (typeof moment === 'undefined') {
            console.error("Moment.js is not loaded. Cannot generate mock data.");
            return data;
        }

        const endDate = moment();
        const startDate = moment().subtract(365, 'days');
        
        let currentDay = startDate.clone();
        while (currentDay.isBefore(endDate)) {
            const dayString = currentDay.format('YYYY-MM-DD');
            const weekString = `Week ${currentDay.isoWeek()} ${currentDay.isoWeekYear()}`; // Mocking the week format

            const baseStake = Math.floor(Math.random() * 20000 + 50000);
            const dailyPL = Math.floor(Math.random() * 2000 - 500);
            const dailyROI = (dailyPL / baseStake) * 100 * (1 + Math.random() * 0.5);

            data.push({
                _id: dayString,
                date: dayString,
                stake: baseStake,
                pl: dailyPL,
                roi: Math.max(-5, parseFloat(dailyROI.toFixed(2))),
                events: Math.floor(Math.random() * 15 + 5),
                week: weekString // Added mock week data
            });
            currentDay.add(1, 'day');
        }
        return data;
    }

    /**
     * Fetches real daily analytics data from the API endpoint using a robust fetch configuration.
     */
    async function fetchDailyAnalytics(profileId) {
        
        const encodedProfileId = encodeURIComponent(profileId);
        const apiEndpoint = `https://4751210766c8.ngrok-free.app/daily-stats?client1=${encodedProfileId}`; 

        const requestOptions = {
            method: "GET",
            headers: {
                "ngrok-skip-browser-warning": "true",
                "Accept": "application/json" 
            }
        };

        try {
            console.log(`Attempting to fetch data from: ${apiEndpoint}`);
            
            const response = await fetch(apiEndpoint, requestOptions);
            
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status} - Response not OK. Ensure API is running and accessible.`);
            }

            const data = await response.json();
            console.log("Data successfully loaded from API.");
            return data;
            
        } catch (error) {
            console.error("Critical Fetch Error:", error.message);
            console.warn("If the error is 'Failed to fetch' or 'CORS policy', you must configure your backend server (or ngrok) to allow requests from the domain where this dashboard is hosted.");
            console.log("Falling back to mock data...");
            return generateMockData();
        }
    }


    /** Generates mock data for market group comparison charts. */
    function generateMarketData() {
        const stakeData = {};
        const roiData = {};
        
        MARKET_GROUPS.forEach(market => {
            stakeData[market] = Math.floor(Math.random() * 30000 + 5000);
            roiData[market] = parseFloat((Math.random() * 20 - 5).toFixed(1)); 
        });

        return { stakeData, roiData };
    }

    /** Aggregates the main chart data based on the selected view. */
    function aggregateData(view, metric) {
        let aggregated = {};
        let labels = [];
        let data = [];
        let unit = (metric === 'roi') ? '%' : (metric === 'pl' ? '€' : '$'); 

        // --- START OF WEEK FIX ---
        if (view === CHART_VIEWS.WEEK) {
            const weeklyAggregated = {};

            chartData.forEach(item => {
                // IMPORTANT: Use the 'week' property directly from the API object
                const key = item.week; 

                // Ensure the item has the 'week' property before processing
                if (!key) return; 

                weeklyAggregated[key] = (weeklyAggregated[key] || { sum: 0, count: 0, totalStake: 0 });

                if (metric === 'roi') {
                    // Accumulate daily ROI values for average calculation
                    weeklyAggregated[key].sum += item[metric];
                    weeklyAggregated[key].count += 1;
                } else { 
                    // Accumulate daily Stake/PL values for sum calculation
                    weeklyAggregated[key].sum += item[metric];
                }
            });

            // The keys are strings like "Week 32 2025". We need custom sorting.
            // Sort by Year (last 4 chars) then Week Number (after "Week ")
            const orderedKeys = Object.keys(weeklyAggregated).sort((a, b) => {
                const yearA = parseInt(a.substring(a.length - 4));
                const weekA = parseInt(a.substring(5, a.indexOf(' ', 5)));
                
                const yearB = parseInt(b.substring(b.length - 4));
                const weekB = parseInt(b.substring(5, b.indexOf(' ', 5)));
                
                if (yearA !== yearB) return yearA - yearB;
                return weekA - weekB;
            });
            
            data = orderedKeys.map(key => {
                const item = weeklyAggregated[key];
                if (metric === 'roi') {
                    // Calculate average daily ROI for the week
                    return parseFloat((item.sum / item.count).toFixed(2));
                }
                return item.sum;
            });
            
            // Format labels to just show "Wk 32"
            labels = orderedKeys.map(key => {
                 const weekNum = key.substring(5, key.indexOf(' ', 5));
                 return `Wk ${weekNum}`;
            });
        
        // --- END OF WEEK FIX ---

        } else {
            // Logic for YEAR (Monthly Aggregation) and MONTH (Daily Aggregation)
            
            const filterAndGroup = (item, date) => {
                let key = '';
                switch (view) {
                    case CHART_VIEWS.YEAR:
                        key = date.format('YYYY-MM');
                        break;
                    case CHART_VIEWS.MONTH:
                        if (moment().diff(date, 'days') <= 30) {
                            key = date.format('MM/DD');
                        }
                        break;
                }
                return key;
            };

            chartData.forEach(item => {
                const date = moment(item.date);
                const key = filterAndGroup(item, date);

                if (key) {
                    if (metric === 'roi') {
                        aggregated[key] = (aggregated[key] || { sum: 0, count: 0 });
                        aggregated[key].sum += item[metric];
                        aggregated[key].count += 1;
                    } else {
                        aggregated[key] = (aggregated[key] || 0) + item[metric];
                    }
                }
            });

            labels = Object.keys(aggregated).sort();
            data = labels.map(key => {
                if (metric === 'roi') {
                    const avg = aggregated[key].sum / aggregated[key].count;
                    return parseFloat(avg.toFixed(2));
                }
                return aggregated[key];
            });

            if (view === CHART_VIEWS.YEAR) {
                labels = labels.map(key => moment(key, 'YYYY-MM').format('MMM'));
            }
        }
        
        return { labels, data, unit };
    }

    // --- Chart Configuration Templates (unchanged) ---

    function getChartConfig(type, labels, data, metric, unit, colorKey) {
        const isLine = type === 'line';
        const accentColor = tailwind.config.theme.extend.colors[colorKey] || tailwind.config.theme.extend.colors['accent-1'];

        let backgroundColor;
        let borderWidth;
        let pointRadius = 0;

        if (isLine) {
            backgroundColor = accentColor + '40';
            borderWidth = 3;
            pointRadius = 5;
        } else {
            backgroundColor = 'transparent';
            borderWidth = 2; 
        }

        return {
            type: type,
            data: {
                labels: labels,
                datasets: [{
                    label: metric.toUpperCase(),
                    data: data,
                    borderColor: accentColor,
                    backgroundColor: backgroundColor,
                    borderWidth: borderWidth,
                    pointRadius: pointRadius,
                    pointBackgroundColor: accentColor,
                    tension: 0.4,
                    fill: isLine ? 'origin' : false,
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: (c) => {
                                const value = c.parsed.y;
                                if (metric === 'roi') return `${c.dataset.label}: ${value.toFixed(2)}%`;
                                if (metric === 'pl') return `${c.dataset.label}: € ${value.toLocaleString()}`;
                                return `${c.dataset.label}: $ ${value.toLocaleString()}`;
                            }
                        },
                        backgroundColor: tailwind.config.theme.extend.colors['surface'],
                        titleFont: { size: 14, weight: 'bold' },
                        bodyFont: { size: 14 },
                        padding: 10,
                        cornerRadius: 6,
                        borderWidth: 1,
                        borderColor: tailwind.config.theme.extend.colors['accent-1'] + '40'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { color: tailwind.config.theme.extend.colors['text-muted'] + '20' },
                        ticks: {
                            color: tailwind.config.theme.extend.colors['text-light'],
                            callback: (value) => {
                                let prefix = '';
                                if (unit === '$') prefix = '$';
                                else if (unit === '€') prefix = '€';
                                
                                if (value > 10000 || value < -10000) {
                                    return `${prefix}${(value / 1000).toFixed(0)}K`;
                                }
                                return `${prefix}${value}${unit === '%' ? '%' : ''}`;
                            },
                        },
                    },
                    x: {
                        grid: { display: false },
                        ticks: { color: tailwind.config.theme.extend.colors['text-muted'] },
                    }
                }
            }
        };
    }

    // --- Chart Rendering Functions (unchanged logic) ---

    function renderMainChart() {
        const canvas = document.getElementById('mainChart');
        if (!canvas) return;
        
        const { labels, data, unit } = aggregateData(currentView, currentTab);
        const colorKey = currentTab === 'pl' ? 'accent-2' : (currentTab === 'roi' ? 'chart-green' : 'accent-1');

        mainTitleEl.textContent = currentTab.toUpperCase();

        const config = getChartConfig('line', labels, data, currentTab, unit, colorKey);
        config.options.scales.y.beginAtZero = (currentTab === 'roi' || currentTab === 'pl'); 

        if (mainChartInstance) {
            mainChartInstance.data = config.data;
            mainChartInstance.options = config.options;
            mainChartInstance.update();
        } else {
            mainChartInstance = new Chart(canvas.getContext('2d'), config);
        }
    }

    function renderEventsChart() {
        if (!chartData || chartData.length === 0) return;
        const latestData = chartData.slice(-56);
        
        const weeklyEvents = {};
        latestData.forEach(item => {
            // Use the week property from the item
            const weekKey = item.week; 
            if (!weekKey) return; 
            weeklyEvents[weekKey] = (weeklyEvents[weekKey] || 0) + item.events;
        });
        
        // Use the same custom sorting as in aggregateData
        const orderedKeys = Object.keys(weeklyEvents).sort((a, b) => {
            const yearA = parseInt(a.substring(a.length - 4));
            const weekA = parseInt(a.substring(5, a.indexOf(' ', 5)));
            
            const yearB = parseInt(b.substring(b.length - 4));
            const weekB = parseInt(b.substring(5, b.indexOf(' ', 5)));
            
            if (yearA !== yearB) return yearA - yearB;
            return weekA - weekB;
        });

        const orderedData = orderedKeys.map(k => weeklyEvents[k]);
        const labels = orderedKeys.map(key => {
             const weekNum = key.substring(5, key.indexOf(' ', 5));
             return `Wk ${weekNum}`;
        });

        const config = getChartConfig('line', labels, orderedData, 'Events', ' Events', 'accent-1');
        config.options.elements = { line: { tension: 0.2 }, point: { radius: 3 } };

        new Chart(document.getElementById('eventsPerWeekChart').getContext('2d'), config);
    }

    function renderMarketCharts() {
        const { stakeData, roiData } = generateMarketData();

        const stakeLabels = MARKET_GROUPS;
        const stakeValues = MARKET_GROUPS.map(m => stakeData[m]);
        const stakeConfig = getChartConfig('bar', stakeLabels, stakeValues, 'Stake', '$', 'accent-2');
        stakeConfig.options.scales.x.ticks.callback = (val) => stakeLabels[val]; 
        new Chart(document.getElementById('stakePerMarketChart').getContext('2d'), stakeConfig);

        const roiLabels = MARKET_GROUPS;
        const roiValues = MARKET_GROUPS.map(m => roiData[m]);
        const roiConfig = getChartConfig('bar', roiLabels, roiValues, 'ROI', '%', 'chart-green');
        roiConfig.options.scales.x.ticks.callback = (val) => roiLabels[val]; 
        roiConfig.options.scales.y.beginAtZero = false;
        
        new Chart(document.getElementById('roiPerMarketChart').getContext('2d'), roiConfig);
    }

    // --- Interaction Handlers (unchanged) ---

    function switchView(view) {
        currentView = view;
        
        viewButtons.forEach(btn => {
            const isActive = btn.dataset.view === view;
            btn.classList.toggle('bg-surface/50', isActive);
            btn.classList.toggle('text-white', isActive);
            btn.classList.toggle('hover:bg-surface/50', !isActive);
            btn.classList.toggle('text-text-muted', !isActive);
        });

        renderMainChart();
    }

    function switchTab(tab) {
        currentTab = tab;

        tabButtons.forEach(btn => {
            const isActive = btn.dataset.tab === tab;
            
            const isStake = tab === 'stake';
            const isPL = tab === 'pl';
            const isROI = tab === 'roi';

            btn.classList.toggle('bg-accent-1', isStake && isActive);
            btn.classList.toggle('bg-accent-2', isPL && isActive);
            btn.classList.toggle('bg-chart-green', isROI && isActive);
            
            btn.classList.toggle('text-white', isActive);
            btn.classList.toggle('shadow-lg', isActive);
            
            btn.classList.toggle('bg-transparent', !isActive);
            btn.classList.toggle('hover:text-white', !isActive);
            btn.classList.toggle('text-text-muted', !isActive);
            btn.classList.toggle('shadow-none', !isActive);
        });

        renderMainChart();
    }


    /** Application startup function. */
    async function initializeApp() {
        const params = new URLSearchParams(window.location.search);
        const profile = params.get("profile") || "User";

        document.getElementById("profileTitle").innerText = profile + " Analytics & Stats";

        await window.initFirebase();

        chartData = await fetchDailyAnalytics(profile);

        const totalEvents = chartData.reduce((sum, item) => sum + item.events, 0);
        totalEventsCountEl.textContent = totalEvents.toLocaleString();

        // 3. Set up Event Listeners
        document.getElementById('menu-toggle').addEventListener('click', toggleSidebar);
        document.querySelectorAll('.sidebar-link').forEach(link => {
            link.addEventListener('click', () => {
                if (window.innerWidth < 768) {
                    toggleSidebar();
                }
            });
        });

        viewButtons.forEach(button => {
            button.addEventListener('click', () => {
                switchView(button.dataset.view);
            });
        });

        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                switchTab(button.dataset.tab);
            });
        });

        // 4. Initial Render
        switchView(currentView); 
        switchTab(currentTab); 
        renderEventsChart();
        renderMarketCharts();
    }

    // Initialize the app when the DOM is ready
    document.addEventListener('DOMContentLoaded', initializeApp);
</script>
</body>

</html>